<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IBBA Dashboard - All Games</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .sortable {
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s;
    }
    .sortable:hover {
      background-color: #f3f4f6;
    }
    .sort-indicator {
      font-size: 0.75em;
      margin-left: 4px;
      color: #3b82f6;
      font-weight: bold;
    }
    th[onclick] {
      cursor: pointer;
      user-select: none;
    }
    th[onclick]:hover {
      background-color: rgba(59, 130, 246, 0.1);
    }
  </style>
</head>
<body class="bg-slate-100 text-gray-900">
  
  <div class="max-w-none mx-auto px-2 md:px-4 py-4">
    <!-- Header -->
    <div class="header-gradient rounded-lg p-3 mb-3 shadow-md">
      <h1 class="text-2xl font-bold mb-1 text-center">IBBA Dashboard - Pure API</h1>
      <p class="text-sm text-center text-blue-100">×›×œ ×”××©×—×§×™× â€¢ ×œ×œ× ××¡×“ × ×ª×•× ×™× â€¢ × ×ª×•× ×™× ×‘×–××Ÿ ×××ª ×-ibasketball.co.il</p>
      <div class="text-xs text-center text-blue-200 mt-2">
        <span class="bg-blue-800/30 px-2 py-1 rounded-full">v1.1 - Phase 2</span>
      </div>
    </div>
    
    <!-- Tabs Navigation -->
    <nav id="tabs" class="flex flex-wrap items-center gap-2 justify-center mb-4">
      <button id="tab-games" class="tab bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors" onclick="switchTab('games')">
        ×›×œ ×”××©×—×§×™×
      </button>
      <button id="tab-teams" class="tab bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 transition-colors" onclick="switchTab('teams')">
        ×¡×˜×˜×™×¡×˜×™×§×•×ª ×§×‘×•×¦×ª×™×•×ª
      </button>
      <button id="tab-players" class="tab bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 transition-colors" onclick="switchTab('players')">
        ×¡×˜×˜×™×¡×˜×™×§×•×ª ×©×—×§× ×™×
      </button>
      <button id="tab-leaders" class="tab bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 transition-colors" onclick="switchTab('leaders')">
        ××•×‘×™×œ×™ ×”×œ×™×’×”
      </button>
      <button id="tab-gamePrep" class="tab bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 transition-colors" onclick="switchTab('gamePrep')">
        ×”×›× ×” ×œ××©×—×§
      </button>
    </nav>
    
    <!-- Loading Progress -->
    <div id="loadingProgress" class="card p-4 mb-4">
      <div class="text-center">
        <div class="text-lg font-semibold mb-2" id="loadingStatus">ğŸ”„ ×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div id="loadingBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <div class="text-sm text-gray-600 mt-2" id="loadingDetails">×××ª×—×œ...</div>
      </div>
    </div>
    
    <!-- Games Section -->
    <section id="view-games" class="hidden">
      <div class="card p-4">
        <div class="mb-3">
          <h2 class="text-lg font-bold text-blue-900 mb-3">
            ×›×œ ×”××©×—×§×™× (××•×¦×’×™× <span id="displayedCount" class="text-blue-600">0</span> ××ª×•×š <span id="totalCount" class="text-blue-600">0</span> ××©×—×§×™×)
          </h2>
          
          <!-- Filters Row -->
          <div class="flex items-center gap-3 flex-wrap mb-3">
            <!-- Round Filter -->
            <div class="flex items-center gap-2">
              <label for="cycleFilter" class="text-sm font-medium text-gray-700">××—×–×•×¨:</label>
              <select id="cycleFilter" class="px-3 py-2 border border-gray-300 rounded text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">×”×›×œ</option>
              </select>
            </div>
            
            <!-- Team Filter -->
            <div class="flex items-center gap-2">
              <label for="teamFilter" class="text-sm font-medium text-gray-700">×§×‘×•×¦×”:</label>
              <select id="teamFilter" class="px-3 py-2 border border-gray-300 rounded text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">×”×›×œ</option>
              </select>
            </div>
            
            <!-- Search -->
            <div class="flex-1 min-w-[200px] flex gap-2">
              <input id="gamesSearch" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="×—×™×¤×•×© ×—×•×¤×©×™...">
              <button id="searchBtn" class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded border border-blue-600 transition-colors">
                ×—×¤×©
              </button>
            </div>
            
            <!-- Clear Filters -->
            <button id="clearFiltersBtn" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded border border-gray-300 transition-colors">
              × ×§×” ×¡×™× ×•×Ÿ
            </button>
          </div>
        </div>
        
        <!-- Table -->
        <div class="stats-wrap">
          <table class="stats-table w-full text-sm">
            <thead>
              <tr>
                <th class="col-team sortable" data-sort="gameId">
                  <span class="sort-indicator" id="sort-gameId">â–¼</span>××–×”×” ××©×—×§
                </th>
                <th class="num sortable" data-sort="cycle">
                  <span class="sort-indicator" id="sort-cycle"></span>××—×–×•×¨
                </th>
                <th class="num sortable" data-sort="date">
                  <span class="sort-indicator" id="sort-date"></span>×ª××¨×™×š
                </th>
                <th class="col-team">××©×—×§</th>
                <th class="col-team">×ª×•×¦××”</th>
              </tr>
            </thead>
            <tbody id="gamesTbody">
              <tr>
                <td colspan="5" class="text-center py-8 text-gray-500">×˜×•×¢×Ÿ ××©×—×§×™×...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    
    <!-- ========== Team Statistics Section ========== -->
    <section id="view-teams" class="hidden">
      <div class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-bold text-blue-900">×¡×˜×˜×™×¡×˜×™×§×•×ª ×§×‘×•×¦×ª×™×•×ª (<span id="teamsCount">0</span>)</h2>
          <div class="flex gap-2 items-center">
            <input id="teamSearch" class="w-64 px-3 py-2 border rounded text-sm" placeholder="×—×¤×© ×§×‘×•×¦×”" oninput="filterTeams()">
            <button id="teamStatsToggle" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm transition-colors" onclick="toggleTeamStatsView()">
              <span id="teamToggleText">×”×¦×’ ×¡×”"×›</span>
            </button>
          </div>
        </div>
        <div class="stats-wrap">
          <table class="stats-table w-full text-sm">
            <thead>
              <tr>
                <th class="col-team sortable" onclick="sortTeams('name')">
                  ×§×‘×•×¦×” <span id="sort-name" class="sort-indicator"></span>
                </th>
                <th class="num sortable" onclick="sortTeams('gamesPlayed')">
                  ××©' <span id="sort-gamesPlayed" class="sort-indicator"></span>
                </th>
                <th class="num sortable" onclick="sortTeams('ppg')">
                  <span id="pointsHeader">× ×§'</span> <span id="sort-ppg" class="sort-indicator"></span>
                </th>
                <th class="num sortable" onclick="sortTeams('rpg')">
                  <span id="reboundsHeader">×¨×™×‘'</span> <span id="sort-rpg" class="sort-indicator"></span>
                </th>
                <th class="num sortable" onclick="sortTeams('apg')">
                  <span id="assistsHeader">××¡'</span> <span id="sort-apg" class="sort-indicator"></span>
                </th>
                <th class="num sortable" onclick="sortTeams('spg')">
                  <span id="stealsHeader">×—×˜'</span> <span id="sort-spg" class="sort-indicator"></span>
                </th>
                <th class="num sortable" onclick="sortTeams('bpg')">
                  <span id="blocksHeader">×—×¡'</span> <span id="sort-bpg" class="sort-indicator"></span>
                </th>
                <th class="num sortable" onclick="sortTeams('tpg')">
                  <span id="turnoversHeader">××™×‘'</span> <span id="sort-tpg" class="sort-indicator"></span>
                </th>
                <th class="num sortable" onclick="sortTeams('fpg')">
                  <span id="foulsHeader">×¢×‘'</span> <span id="sort-fpg" class="sort-indicator"></span>
                </th>
                <th class="pct sortable" onclick="sortTeams('fgPct')">
                  FG% <span id="sort-fgPct" class="sort-indicator"></span>
                </th>
                <th class="pct sortable" onclick="sortTeams('threePtPct')">
                  3PT% <span id="sort-threePtPct" class="sort-indicator"></span>
                </th>
                <th class="pct sortable" onclick="sortTeams('ftPct')">
                  FT% <span id="sort-ftPct" class="sort-indicator"></span>
                </th>
                <th class="num sortable" onclick="sortTeams('efficiency')">
                  <span id="efficiencyHeader">×™×¢×™×œ×•×ª</span> <span id="sort-efficiency" class="sort-indicator"></span>
                </th>
              </tr>
            </thead>
            <tbody id="teamsTbody">
              <tr>
                <td colspan="13" class="text-center py-8 text-gray-500">×˜×•×¢×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    
    <!-- ========== Player Statistics Section ========== -->
    <section id="view-players" class="hidden">
      <div class="card p-4">
        <div class="mb-3">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-bold text-blue-900">×¡×˜×˜×™×¡×˜×™×§×•×ª ×©×—×§× ×™× (<span id="playersCount">0</span>)</h2>
            
            <!-- Loading indicator for player names -->
            <div id="playerNamesStatus" class="text-sm text-gray-600" style="display: none;">
              <span class="animate-pulse">â³ ×˜×•×¢×Ÿ ×©××•×ª ×©×—×§× ×™×...</span>
            </div>
            
            <!-- Cache refresh button -->
            <button id="refreshPlayerNamesBtn" class="text-xs text-gray-500 hover:text-blue-600 transition" onclick="forceRefreshPlayerNames()" style="display: none;" title="×˜×¢×Ÿ ×©××•×ª ×©×—×§× ×™× ××—×“×© ××”×©×¨×ª">
              ğŸ”„ ×¨×¢× ×Ÿ ×©××•×ª
            </button>
          </div>
          
          <!-- Filters Row with Toggle Button -->
          <div class="flex gap-2 items-center mb-2">
            <select id="playersTeamFilter" class="px-3 py-2 border rounded text-sm" onchange="filterPlayers()">
              <option value="">×›×œ ×”×§×‘×•×¦×•×ª</option>
            </select>
            
            <input id="playersSearch" class="w-64 px-3 py-2 border rounded text-sm" placeholder="×—×¤×© ×œ×¤×™ ×©×/××¡' ×—×•×œ×¦×”" oninput="filterPlayers()">
            
            <button id="clearPlayersFilters" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm" onclick="clearPlayerFilters()">
              × ×§×” ×¡×™× ×•×Ÿ
            </button>
            
            <!-- Spacer to push toggle to the left -->
            <div class="flex-1"></div>
            
            <!-- View Toggle Button -->
            <button id="playersViewToggle" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm transition-colors" onclick="togglePlayerStatsView()">
              <span id="playerToggleText">×”×¦×’ ×¡×”"×›</span>
            </button>
          </div>
        </div>
        <div class="stats-wrap">
          <table class="stats-table" dir="rtl">
            <thead>
              <tr>
                <th class="col-name" data-sort-field="name" onclick="sortPlayers('name')" style="cursor: pointer;">
                  <div class="th-inner">×©×—×§×Ÿ <span id="sort-name" class="sort-indicator"></span></div>
                </th>
                <th class="col-jersey" data-sort-field="jersey" onclick="sortPlayers('jersey')" style="cursor: pointer;">
                  <div class="th-inner">××¡' <span id="sort-jersey" class="sort-indicator"></span></div>
                </th>
                <th class="col-team" data-sort-field="teamName" onclick="sortPlayers('teamName')" style="cursor: pointer;">
                  <div class="th-inner">×§×‘×•×¦×” <span id="sort-teamName" class="sort-indicator"></span></div>
                </th>
                <th class="col-games" data-sort-field="gamesPlayed" onclick="sortPlayers('gamesPlayed')" style="cursor: pointer;">
                  <div class="th-inner">××©' <span id="sort-gamesPlayed" class="sort-indicator"></span></div>
                </th>
                <th class="num points" data-sort-field="ppg" onclick="sortPlayers('ppg')" style="cursor: pointer;">
                  <div class="th-inner"><span id="pointsHeaderPlayer">× ×§'</span> <span id="sort-ppg" class="sort-indicator"></span></div>
                </th>
                <th class="num rebounds" data-sort-field="rpg" onclick="sortPlayers('rpg')" style="cursor: pointer;">
                  <div class="th-inner"><span id="reboundsHeaderPlayer">×¨×™×‘'</span> <span id="sort-rpg" class="sort-indicator"></span></div>
                </th>
                <th class="num assists" data-sort-field="apg" onclick="sortPlayers('apg')" style="cursor: pointer;">
                  <div class="th-inner"><span id="assistsHeaderPlayer">××¡'</span> <span id="sort-apg" class="sort-indicator"></span></div>
                </th>
                <th class="num" data-sort-field="spg" onclick="sortPlayers('spg')" style="cursor: pointer;">
                  <div class="th-inner"><span id="stealsHeaderPlayer">×—×˜'</span> <span id="sort-spg" class="sort-indicator"></span></div>
                </th>
                <th class="num" data-sort-field="bpg" onclick="sortPlayers('bpg')" style="cursor: pointer;">
                  <div class="th-inner"><span id="blocksHeaderPlayer">×—×¡'</span> <span id="sort-bpg" class="sort-indicator"></span></div>
                </th>
                <th class="num" data-sort-field="tpg" onclick="sortPlayers('tpg')" style="cursor: pointer;">
                  <div class="th-inner"><span id="turnoversHeaderPlayer">××™×‘'</span> <span id="sort-tpg" class="sort-indicator"></span></div>
                </th>
                <th class="num" data-sort-field="fpg" onclick="sortPlayers('fpg')" style="cursor: pointer;">
                  <div class="th-inner"><span id="foulsHeaderPlayer">×¢×‘'</span> <span id="sort-fpg" class="sort-indicator"></span></div>
                </th>
                <th class="num" data-sort-field="foulsDrawnPg" onclick="sortPlayers('foulsDrawnPg')" style="cursor: pointer;">
                  <div class="th-inner"><span id="foulsDrawnHeaderPlayer">×¡×—×˜'</span> <span id="sort-foulsDrawnPg" class="sort-indicator"></span></div>
                </th>
                <th class="num pct" data-sort-field="fgPct" onclick="sortPlayers('fgPct')" style="cursor: pointer;">
                  <div class="th-inner">FG% <span id="sort-fgPct" class="sort-indicator"></span></div>
                </th>
                <th class="num pct" data-sort-field="threePtPct" onclick="sortPlayers('threePtPct')" style="cursor: pointer;">
                  <div class="th-inner">3PT% <span id="sort-threePtPct" class="sort-indicator"></span></div>
                </th>
                <th class="num pct" data-sort-field="ftPct" onclick="sortPlayers('ftPct')" style="cursor: pointer;">
                  <div class="th-inner">FT% <span id="sort-ftPct" class="sort-indicator"></span></div>
                </th>
                <th class="num efficiency" data-sort-field="efficiencyAvg" onclick="sortPlayers('efficiencyAvg')" style="cursor: pointer;">
                  <div class="th-inner"><span id="efficiencyHeaderPlayer">×™×¢×™×œ×•×ª</span> <span id="sort-efficiencyAvg" class="sort-indicator"></span></div>
                </th>
              </tr>
            </thead>
            <tbody id="playersTbody">
              <tr>
                <td colspan="16" class="text-center py-8 text-gray-500">×˜×•×¢×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×©×—×§× ×™×...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    
    <!-- ========== League Leaders Section ========== -->
    <section id="view-leaders" class="hidden">
      <div class="card p-4">
        <h2 class="text-lg font-bold mb-4 text-blue-900">××•×‘×™×œ×™ ×”×œ×™×’×”</h2>
        
        <!-- Grid layout for stat categories -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          
          <!-- Points Leaders -->
          <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-800 to-blue-900 p-3">
              <h3 class="text-white font-bold text-center">× ×§×•×“×•×ª ×œ××©×—×§</h3>
            </div>
            <div class="p-3">
              <table class="w-full text-sm" id="leadersPoints">
                <thead>
                  <tr class="border-b-2 border-gray-300 text-gray-700 text-xs">
                    <th class="text-right py-2 px-2">#</th>
                    <th class="text-right py-2 px-2">×©×—×§×Ÿ</th>
                    <th class="text-right py-2 px-2">×§×‘×•×¦×”</th>
                    <th class="text-center py-2 px-2">××©'</th>
                    <th class="text-center py-2 px-2">×××•×¦×¢</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center py-4 text-gray-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Rebounds Leaders -->
          <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-800 to-blue-900 p-3">
              <h3 class="text-white font-bold text-center">×¨×™×‘××•× ×“×™× ×œ××©×—×§</h3>
            </div>
            <div class="p-3">
              <table class="w-full text-sm" id="leadersRebounds">
                <thead>
                  <tr class="border-b-2 border-gray-300 text-gray-700 text-xs">
                    <th class="text-right py-2 px-2">#</th>
                    <th class="text-right py-2 px-2">×©×—×§×Ÿ</th>
                    <th class="text-right py-2 px-2">×§×‘×•×¦×”</th>
                    <th class="text-center py-2 px-2">××©'</th>
                    <th class="text-center py-2 px-2">×××•×¦×¢</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center py-4 text-gray-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Assists Leaders -->
          <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-800 to-blue-900 p-3">
              <h3 class="text-white font-bold text-center">××¡×™×¡×˜×™× ×œ××©×—×§</h3>
            </div>
            <div class="p-3">
              <table class="w-full text-sm" id="leadersAssists">
                <thead>
                  <tr class="border-b-2 border-gray-300 text-gray-700 text-xs">
                    <th class="text-right py-2 px-2">#</th>
                    <th class="text-right py-2 px-2">×©×—×§×Ÿ</th>
                    <th class="text-right py-2 px-2">×§×‘×•×¦×”</th>
                    <th class="text-center py-2 px-2">××©'</th>
                    <th class="text-center py-2 px-2">×××•×¦×¢</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center py-4 text-gray-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Steals Leaders -->
          <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-800 to-blue-900 p-3">
              <h3 class="text-white font-bold text-center">×—×˜×™×¤×•×ª ×œ××©×—×§</h3>
            </div>
            <div class="p-3">
              <table class="w-full text-sm" id="leadersSteals">
                <thead>
                  <tr class="border-b-2 border-gray-300 text-gray-700 text-xs">
                    <th class="text-right py-2 px-2">#</th>
                    <th class="text-right py-2 px-2">×©×—×§×Ÿ</th>
                    <th class="text-right py-2 px-2">×§×‘×•×¦×”</th>
                    <th class="text-center py-2 px-2">××©'</th>
                    <th class="text-center py-2 px-2">×××•×¦×¢</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center py-4 text-gray-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Blocks Leaders -->
          <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-800 to-blue-900 p-3">
              <h3 class="text-white font-bold text-center">×—×¡×™××•×ª ×œ××©×—×§</h3>
            </div>
            <div class="p-3">
              <table class="w-full text-sm" id="leadersBlocks">
                <thead>
                  <tr class="border-b-2 border-gray-300 text-gray-700 text-xs">
                    <th class="text-right py-2 px-2">#</th>
                    <th class="text-right py-2 px-2">×©×—×§×Ÿ</th>
                    <th class="text-right py-2 px-2">×§×‘×•×¦×”</th>
                    <th class="text-center py-2 px-2">××©'</th>
                    <th class="text-center py-2 px-2">×××•×¦×¢</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center py-4 text-gray-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Efficiency Leaders -->
          <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-800 to-blue-900 p-3">
              <h3 class="text-white font-bold text-center">×™×¢×™×œ×•×ª ×œ××©×—×§</h3>
            </div>
            <div class="p-3">
              <table class="w-full text-sm" id="leadersEfficiency">
                <thead>
                  <tr class="border-b-2 border-gray-300 text-gray-700 text-xs">
                    <th class="text-right py-2 px-2">#</th>
                    <th class="text-right py-2 px-2">×©×—×§×Ÿ</th>
                    <th class="text-right py-2 px-2">×§×‘×•×¦×”</th>
                    <th class="text-center py-2 px-2">××©'</th>
                    <th class="text-center py-2 px-2">×××•×¦×¢</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center py-4 text-gray-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Minutes Leaders -->
          <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-800 to-blue-900 p-3">
              <h3 class="text-white font-bold text-center">×“×§×•×ª ×œ××©×—×§</h3>
            </div>
            <div class="p-3">
              <table class="w-full text-sm" id="leadersMinutes">
                <thead>
                  <tr class="border-b-2 border-gray-300 text-gray-700 text-xs">
                    <th class="text-right py-2 px-2">#</th>
                    <th class="text-right py-2 px-2">×©×—×§×Ÿ</th>
                    <th class="text-right py-2 px-2">×§×‘×•×¦×”</th>
                    <th class="text-center py-2 px-2">××©'</th>
                    <th class="text-center py-2 px-2">×××•×¦×¢</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center py-4 text-gray-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- FG% Leaders -->
          <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-800 to-blue-900 p-3">
              <h3 class="text-white font-bold text-center">××—×•×–×™ ×©×“×” (FG%)</h3>
            </div>
            <div class="p-3">
              <table class="w-full text-sm" id="leadersFG">
                <thead>
                  <tr class="border-b-2 border-gray-300 text-gray-700 text-xs">
                    <th class="text-right py-2 px-2">#</th>
                    <th class="text-right py-2 px-2">×©×—×§×Ÿ</th>
                    <th class="text-right py-2 px-2">×§×‘×•×¦×”</th>
                    <th class="text-center py-2 px-2">××©'</th>
                    <th class="text-center py-2 px-2">××—×•×–</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center py-4 text-gray-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- 3PT% Leaders -->
          <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-800 to-blue-900 p-3">
              <h3 class="text-white font-bold text-center">××—×•×–×™ ×©×œ×•×© (3PT%)</h3>
            </div>
            <div class="p-3">
              <table class="w-full text-sm" id="leaders3PT">
                <thead>
                  <tr class="border-b-2 border-gray-300 text-gray-700 text-xs">
                    <th class="text-right py-2 px-2">#</th>
                    <th class="text-right py-2 px-2">×©×—×§×Ÿ</th>
                    <th class="text-right py-2 px-2">×§×‘×•×¦×”</th>
                    <th class="text-center py-2 px-2">××©'</th>
                    <th class="text-center py-2 px-2">××—×•×–</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center py-4 text-gray-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- FT% Leaders -->
          <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-800 to-blue-900 p-3">
              <h3 class="text-white font-bold text-center">××—×•×–×™ ×¢×•× ×©×™×Ÿ (FT%)</h3>
            </div>
            <div class="p-3">
              <table class="w-full text-sm" id="leadersFT">
                <thead>
                  <tr class="border-b-2 border-gray-300 text-gray-700 text-xs">
                    <th class="text-right py-2 px-2">#</th>
                    <th class="text-right py-2 px-2">×©×—×§×Ÿ</th>
                    <th class="text-right py-2 px-2">×§×‘×•×¦×”</th>
                    <th class="text-center py-2 px-2">××©'</th>
                    <th class="text-center py-2 px-2">××—×•×–</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-center py-4 text-gray-400">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- Game Preparation Section -->
    <section id="view-gamePrep" class="hidden">
      <div class="card p-4">
        <h2 class="text-lg font-bold mb-4 text-blue-900">×”×›× ×” ×œ××©×—×§ ×”×‘×</h2>
        
        <!-- Upcoming Games -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-green-800">ğŸ“… ××©×—×§×™× ×§×¨×•×‘×™× ××”×œ×™×’×”</h3>
            <div class="flex items-center gap-2">
              <span id="upcomingGamesStatus" class="text-sm text-green-700 hidden"></span>
              <button id="refreshUpcomingGames" class="btn bg-green-600 text-white text-sm rounded px-3 py-2 hover:bg-green-700 transition-colors">
                ğŸ”„ ×¨×¢× ×Ÿ
              </button>
            </div>
          </div>
          
          <!-- Round Selector -->
          <div class="mb-3">
            <label class="block text-sm font-medium text-gray-700 mb-2">×‘×—×¨ ××—×–×•×¨:</label>
            <select id="roundSelector" class="w-full md:w-64 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500">
              <option value="">×˜×•×¢×Ÿ ××—×–×•×¨×™×...</option>
            </select>
          </div>
          
          <!-- Games Table -->
          <div id="upcomingGamesContainer" class="stats-wrap" style="max-height: 400px;">
            <div class="text-center py-8 text-gray-500">
              <div class="text-4xl mb-2">ğŸ€</div>
              <p>×˜×•×¢×Ÿ ××©×—×§×™× ×§×¨×•×‘×™×...</p>
            </div>
          </div>
        </div>
        
        <!-- Team Selection -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 overflow-hidden">
          <h3 class="font-semibold text-blue-800 mb-3">×‘×—×™×¨×ª ×§×‘×•×¦×•×ª</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">×§×‘×•×¦×ª ×‘×™×ª</label>
              <select id="homeTeamSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">×‘×—×¨ ×§×‘×•×¦×ª ×‘×™×ª...</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">×§×‘×•×¦×ª ×—×•×¥</label>
              <select id="awayTeamSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">×‘×—×¨ ×§×‘×•×¦×ª ×—×•×¥...</option>
              </select>
            </div>
          </div>
          <button id="analyzeGame" class="mt-4 w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <span class="text-lg">ğŸ“Š × ×ª×— ××©×—×§</span>
          </button>
        </div>

        <!-- Analysis Results -->
        <div id="gameAnalysis" class="hidden">
          <!-- Player Comparison -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h3 class="font-semibold text-blue-800 mb-3">×”×©×•×•××ª ×©×—×§× ×™×</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Player 1 Selection -->
              <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">×©×—×§×Ÿ ×¨××©×•×Ÿ</label>
                <select id="player1Select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                  <option value="">×‘×—×¨ ×©×—×§×Ÿ ×¨××©×•×Ÿ...</option>
                </select>
                <div id="player1Stats" class="hidden bg-white border border-gray-200 rounded-lg p-3">
                  <!-- Player 1 stats will be populated here -->
                </div>
              </div>

              <!-- Player 2 Selection -->
              <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">×©×—×§×Ÿ ×©× ×™</label>
                <select id="player2Select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" disabled>
                  <option value="">×‘×—×¨ ×©×—×§×Ÿ ×©× ×™...</option>
                </select>
                <div id="player2Stats" class="hidden bg-white border border-gray-200 rounded-lg p-3">
                  <!-- Player 2 stats will be populated here -->
                </div>
              </div>
            </div>

            <!-- Comparison Results -->
            <div id="playerComparison" class="hidden mt-6">
              <h4 class="font-semibold text-blue-800 mb-3">×ª×•×¦××•×ª ×”×©×•×•××”</h4>
              <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                <table class="w-full">
                  <tbody id="comparisonTableBody" class="divide-y divide-gray-200">
                    <!-- Comparison rows will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Top Row: Averages & Last 5 Games Side by Side -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 items-start">
            <!-- Team Averages & Rankings -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
              <h3 class="font-semibold text-gray-800 mb-4">×××•×¦×¢×™× ×•×“×™×¨×•×’×™×</h3>
              <div id="teamAverages" class="grid grid-cols-1 gap-4">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>

            <!-- Last 5 Games -->
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
              <h3 class="font-semibold text-orange-800 mb-4 text-base">5 ××©×—×§×™× ××—×¨×•× ×™×</h3>
              <div id="lastFiveGames" class="grid grid-cols-1 gap-4">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
          </div>

          <!-- Head-to-Head History -->
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
            <h3 class="font-semibold text-purple-800 mb-3">××¤×’×©×™× ×™×©×™×¨×™× ×‘×¢×•× ×”</h3>
            <div id="headToHead" class="overflow-x-auto">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
  
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js"></script>
  <script src="js/ibba/ibba_adapter.js?v=6"></script>
  <script src="js/ibba/ibba_analytics.js?v=7"></script>
  <script src="js/ibba/ibba_player_names.js?v=8" defer></script>
  <script src="js/app_upcoming_games_pure.js?v=2" defer></script>

  <script>
    // ========================================
    // IBBA Dashboard v1 - All Games Tab
    // ========================================
    
    console.log('ğŸ¯ IBBA Dashboard v1 initializing...');
    
    // Global state - Games Tab (expose as window.allGames for external scripts)
    window.allGames = [];
    let allGames = window.allGames; // Local reference for convenience
    let filteredGames = [];
    let currentSort = { field: 'gameId', direction: 'desc' };
    
    // Global state - Teams Tab
    let allTeamStats = [];
    let filteredTeamStats = [];
    let currentTeamStatsView = 'averages'; // 'averages' or 'totals'
    let currentTeamSort = { field: 'points', direction: 'desc' };
    
    // Global state - Players Tab
    let allPlayerStats = [];
    let filteredPlayerStats = [];
    let currentPlayerStatsView = 'averages'; // 'averages' or 'totals'
    let currentPlayerSort = { field: 'ppg', direction: 'desc' };
    
    // Global state - League Leaders Tab
    let leaderStats = null;
    
    // Global state - Game Prep Tab
    let gamePrepState = {
      homeTeamName: null,
      awayTeamName: null,
      selectedPlayer1: null,
      selectedPlayer2: null,
      upcomingGames: [],
      rounds: [],
      initialized: false
    };
    
    // ========================================
    // TAB SWITCHING
    // ========================================
    
    function switchTab(tabName) {
      console.log(`ğŸ”„ Switching to tab: ${tabName}`);
      
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      
      const activeTab = document.getElementById(`tab-${tabName}`);
      if (activeTab) {
        activeTab.classList.remove('bg-gray-200', 'text-gray-700');
        activeTab.classList.add('bg-blue-600', 'text-white');
      }
      
      // Hide all sections
      document.querySelectorAll('section[id^="view-"]').forEach(section => {
        section.classList.add('hidden');
      });
      
      // Show selected section
      const section = document.getElementById(`view-${tabName}`);
      if (section) {
        section.classList.remove('hidden');
        
        // Initialize stats if switching to tab for the first time
        if (tabName === 'teams' && allTeamStats.length === 0) {
          initTeamStats();
        }
        if (tabName === 'players' && allPlayerStats.length === 0) {
          initPlayerStats();
        }
        if (tabName === 'leaders' && leaderStats === null) {
          initLeaderStats();
        }
        if (tabName === 'gamePrep' && !gamePrepState.initialized) {
          initGamePrep();
        }
      }
    }
    
    // ========================================
    // TEAM STATISTICS FUNCTIONS
    // ========================================
    
    /**
     * Initialize team statistics from loaded games
     */
    function initTeamStats() {
      console.log('ğŸ“Š Initializing team statistics...');
      
      if (!window.ibbaAnalytics) {
        console.error('âŒ IBBAAnalytics not initialized');
        return;
      }
      
      // Get averages (default view)
      const averages = window.ibbaAnalytics.getTeamAverages();
      
      // Convert to array format if needed
      allTeamStats = Array.isArray(averages) ? averages : Object.entries(averages).map(([teamName, stats]) => ({
        name: teamName,
        ...stats
      }));
      
      console.log(`âœ… Loaded ${allTeamStats.length} teams`);
      
      // Apply initial filter and render
      filterTeams();
    }
    
    /**
     * Toggle between averages and totals view
     */
    function toggleTeamStatsView() {
      const button = document.getElementById('teamToggleText');
      
      if (currentTeamStatsView === 'averages') {
        // Switch to totals
        currentTeamStatsView = 'totals';
        button.textContent = '×”×¦×’ ×××•×¦×¢×™×';
        
        // Update headers
        document.getElementById('pointsHeader').textContent = '×¡×”"×› × ×§\'';
        document.getElementById('reboundsHeader').textContent = '×¡×”"×› ×¨×™×‘\'';
        document.getElementById('assistsHeader').textContent = '×¡×”"×› ××¡\'';
        document.getElementById('stealsHeader').textContent = '×¡×”"×› ×—×˜\'';
        document.getElementById('blocksHeader').textContent = '×¡×”"×› ×—×¡\'';
        document.getElementById('turnoversHeader').textContent = '×¡×”"×› ××™×‘\'';
        document.getElementById('foulsHeader').textContent = '×¡×”"×› ×¢×‘\'';
        document.getElementById('efficiencyHeader').textContent = '×¡×”"×› ×™×¢×™×œ×•×ª';
        
        // Get totals data from analytics
        const totals = window.ibbaAnalytics.getTeamStats();
        allTeamStats = Object.values(totals).map(team => ({
          name: team.teamName,
          gamesPlayed: team.gamesPlayed,
          points: team.totalPoints,
          rebounds: team.totalRebounds,
          assists: team.totalAssists,
          steals: team.totalSteals,
          blocks: team.totalBlocks,
          turnovers: team.totalTurnovers,
          fouls: team.totalFouls,
          fgPct: team.totalFGA > 0 ? (team.totalFGM / team.totalFGA * 100) : 0,
          threePtPct: team.total3PA > 0 ? (team.total3PM / team.total3PA * 100) : 0,
          ftPct: team.totalFTA > 0 ? (team.totalFTM / team.totalFTA * 100) : 0,
          efficiency: team.totalEfficiency // Use efficiency from API (sum of player efficiencies)
        }));
        
      } else {
        // Switch to averages
        currentTeamStatsView = 'averages';
        button.textContent = '×”×¦×’ ×¡×”"×›';
        
        // Update headers
        document.getElementById('pointsHeader').textContent = '× ×§\'';
        document.getElementById('reboundsHeader').textContent = '×¨×™×‘\'';
        document.getElementById('assistsHeader').textContent = '××¡\'';
        document.getElementById('stealsHeader').textContent = '×—×˜\'';
        document.getElementById('blocksHeader').textContent = '×—×¡\'';
        document.getElementById('turnoversHeader').textContent = '××™×‘\'';
        document.getElementById('foulsHeader').textContent = '×¢×‘\'';
        document.getElementById('efficiencyHeader').textContent = '×™×¢×™×œ×•×ª';
        
        // Get averages data
        const averages = window.ibbaAnalytics.getTeamAverages();
        allTeamStats = Array.isArray(averages) ? averages : Object.values(averages);
      }
      
      // Re-filter and render
      filterTeams();
    }
    
    /**
     * Filter teams by search term
     */
    function filterTeams() {
      const searchTerm = document.getElementById('teamSearch').value.toLowerCase().trim();
      
      if (!searchTerm) {
        filteredTeamStats = [...allTeamStats];
      } else {
        filteredTeamStats = allTeamStats.filter(team => {
          const teamName = team.teamName || team.name;
          return teamName.toLowerCase().includes(searchTerm);
        });
      }
      
      // Sort and render
      sortTeams(currentTeamSort.field, true);
    }
    
    // Expose team functions globally for onclick/oninput handlers
    window.toggleTeamStatsView = toggleTeamStatsView;
    window.filterTeams = filterTeams;
    
    /**
     * Sort teams by field
     */
    function sortTeams(field, skipToggle = false) {
      console.log(`ğŸ“Š Sorting teams by ${field}`);
      
      // Toggle direction if clicking same field
      if (!skipToggle && currentTeamSort.field === field) {
        currentTeamSort.direction = currentTeamSort.direction === 'asc' ? 'desc' : 'asc';
      } else if (!skipToggle) {
        currentTeamSort.field = field;
        currentTeamSort.direction = 'desc'; // Default to descending for new field
      }
      
      // Sort
      filteredTeamStats.sort((a, b) => {
        const teamNameA = a.teamName || a.name;
        const teamNameB = b.teamName || b.name;
        
        let valA, valB;
        
        if (field === 'name') {
          valA = teamNameA;
          valB = teamNameB;
          return currentTeamSort.direction === 'asc' 
            ? valA.localeCompare(valB, 'he')
            : valB.localeCompare(valA, 'he');
        }
        
        // Special handling for efficiency (calculated field)
        if (field === 'efficiency') {
          valA = calculateEfficiency(a);
          valB = calculateEfficiency(b);
        } else {
          valA = a[field];
          valB = b[field];
        }
        
        // Handle numeric fields - convert strings to numbers if needed
        valA = parseFloat(valA) || 0;
        valB = parseFloat(valB) || 0;
        
        if (currentTeamSort.direction === 'asc') {
          return valA - valB;
        } else {
          return valB - valA;
        }
      });
      
      // Update indicators
      updateTeamSortIndicators();
      
      // Render
      renderTeams();
    }
    
    // Expose sortTeams globally for onclick handlers
    window.sortTeams = sortTeams;
    
    /**
     * Update sort indicators
     */
    function updateTeamSortIndicators() {
      // Clear all
      document.querySelectorAll('.sort-indicator').forEach(span => {
        span.textContent = '';
      });
      
      // Set current
      const indicator = document.getElementById(`sort-${currentTeamSort.field}`);
      if (indicator) {
        indicator.textContent = currentTeamSort.direction === 'asc' ? 'â–²' : 'â–¼';
      }
    }
    
    /**
     * Render teams table
     */
    function renderTeams() {
      const tbody = document.getElementById('teamsTbody');
      const countSpan = document.getElementById('teamsCount');
      
      if (!filteredTeamStats.length) {
        tbody.innerHTML = '<tr><td colspan="13" class="text-center py-8 text-gray-500">×œ× × ××¦××• ×§×‘×•×¦×•×ª</td></tr>';
        countSpan.textContent = '0';
        return;
      }
      
      tbody.innerHTML = filteredTeamStats.map(team => {
        const teamName = team.teamName || team.name;
        return `
          <tr class="hover:bg-blue-50 transition">
            <td class="col-team font-semibold text-blue-900">${teamName}</td>
            <td class="num">${team.gamesPlayed}</td>
            <td class="num">${formatNumber(team.ppg || team.points)}</td>
            <td class="num">${formatNumber(team.rpg || team.rebounds)}</td>
            <td class="num">${formatNumber(team.apg || team.assists)}</td>
            <td class="num">${formatNumber(team.spg || team.steals)}</td>
            <td class="num">${formatNumber(team.bpg || team.blocks)}</td>
            <td class="num">${formatNumber(team.tpg || team.turnovers)}</td>
            <td class="num">${formatNumber(team.fpg || team.fouls)}</td>
            <td class="pct">${formatPercentage(team.fgPct)}</td>
            <td class="pct">${formatPercentage(team.threePtPct || team.threePct)}</td>
            <td class="pct">${formatPercentage(team.ftPct)}</td>
            <td class="num">${formatNumber(calculateEfficiency(team))}</td>
          </tr>
        `;
      }).join('');
      
      countSpan.textContent = filteredTeamStats.length;
    }
    
    /**
     * Format number (1 decimal for averages, 0 for totals)
     */
    function formatNumber(num) {
      if (num == null || isNaN(num)) return '-';
      
      const n = parseFloat(num);
      if (currentTeamStatsView === 'averages') {
        return n.toFixed(1);
      } else {
        return Math.round(n).toString();
      }
    }
    
    /**
     * Format percentage
     */
    function formatPercentage(num) {
      if (num == null || isNaN(num)) return '-';
      return parseFloat(num).toFixed(1) + '%';
    }
    
    /**
     * Calculate efficiency for a team (PURE API - use data from API)
     */
    function calculateEfficiency(team) {
      if (currentTeamStatsView === 'averages') {
        // Use efficiency from API (sum of player efficiencies / games)
        return parseFloat(team.efficiencyAvg) || 0;
      } else {
        // For totals, return total efficiency from API
        return team._totalEfficiency || team.efficiency || 0;
      }
    }
    
    // ========================================
    // PLAYER STATISTICS FUNCTIONS
    // ========================================
    
    /**
     * Get player display name (future-ready for real names)
     */
    function getPlayerDisplayName(player) {
      // Check if player names module exists
      if (window.playerNamesLoader) {
        const name = window.playerNamesLoader.getPlayerName(player.playerId);
        if (name) {
          return name; // Just the name, no jersey number
        }
      }
      
      // Fallback to jersey number
      return `Player #${player.jersey}`;
    }
    
    /**
     * Initialize player statistics
     */
    function initPlayerStats() {
      console.log('ğŸ‘¥ Initializing player statistics...');
      
      if (!window.ibbaAnalytics) {
        console.error('âŒ IBBAAnalytics not initialized');
        return;
      }
      
      // Get averages (default view)
      const averages = window.ibbaAnalytics.getPlayerAverages();
      
      // Add display name to each player
      allPlayerStats = averages.map(player => ({
        ...player,
        name: getPlayerDisplayName(player)
      }));
      
      console.log(`âœ… Loaded ${allPlayerStats.length} players`);
      
      // Populate team filter
      populatePlayerTeamFilter();
      
      // Apply initial filter and render
      filterPlayers();
    }
    
    /**
     * Populate player team filter dropdown
     */
    function populatePlayerTeamFilter() {
      const select = document.getElementById('playersTeamFilter');
      const teams = [...new Set(allPlayerStats.map(p => p.teamName))].sort((a, b) => a.localeCompare(b, 'he'));
      
      // Keep "×›×œ ×”×§×‘×•×¦×•×ª" option, add teams
      select.innerHTML = '<option value="">×›×œ ×”×§×‘×•×¦×•×ª</option>' +
        teams.map(team => `<option value="${team}">${team}</option>`).join('');
    }
    
    /**
     * Toggle between averages and totals view
     */
    function togglePlayerStatsView() {
      const toggleText = document.getElementById('playerToggleText');
      
      if (currentPlayerStatsView === 'averages') {
        // Switch to totals
        currentPlayerStatsView = 'totals';
        toggleText.textContent = '×”×¦×’ ×××•×¦×¢×™×';
        
        // Update headers
        document.getElementById('pointsHeaderPlayer').textContent = '×¡×”"×› × ×§\'';
        document.getElementById('reboundsHeaderPlayer').textContent = '×¡×”"×› ×¨×™×‘\'';
        document.getElementById('assistsHeaderPlayer').textContent = '×¡×”"×› ××¡\'';
        document.getElementById('stealsHeaderPlayer').textContent = '×¡×”"×› ×—×˜\'';
        document.getElementById('blocksHeaderPlayer').textContent = '×¡×”"×› ×—×¡\'';
        document.getElementById('turnoversHeaderPlayer').textContent = '×¡×”"×› ××™×‘\'';
        document.getElementById('foulsHeaderPlayer').textContent = '×¡×”"×› ×¢×‘\'';
        document.getElementById('foulsDrawnHeaderPlayer').textContent = '×¡×”"×› ×¡×—×˜\'';
        document.getElementById('efficiencyHeaderPlayer').textContent = '×¡×”"×› ×™×¢×™×œ×•×ª';
        
        // Update column onclick handlers for totals
        updatePlayerColumnHandlers('totals');
        
        // Get totals data from analytics
        const totals = window.ibbaAnalytics.getPlayerStats();
        allPlayerStats = Object.values(totals).map(player => ({
          ...player,
          name: getPlayerDisplayName(player),
          ppg: player.totalPoints,  // Map to ppg for consistency
          rpg: player.totalRebounds,
          apg: player.totalAssists,
          spg: player.totalSteals,
          bpg: player.totalBlocks,
          tpg: player.totalTurnovers,
          fpg: player.totalFouls,
          foulsDrawnPg: player.totalFoulsDrawn,
          efficiencyAvg: player.totalEfficiency,
          fgPct: player.totalFGA > 0 ? (player.totalFGM / player.totalFGA * 100) : 0,
          threePtPct: player.total3PA > 0 ? (player.total3PM / player.total3PA * 100) : 0,
          ftPct: player.totalFTA > 0 ? (player.totalFTM / player.totalFTA * 100) : 0
        }));
        
      } else {
        // Switch to averages
        currentPlayerStatsView = 'averages';
        toggleText.textContent = '×”×¦×’ ×¡×”"×›';
        
        // Update headers
        document.getElementById('pointsHeaderPlayer').textContent = '× ×§\'';
        document.getElementById('reboundsHeaderPlayer').textContent = '×¨×™×‘\'';
        document.getElementById('assistsHeaderPlayer').textContent = '××¡\'';
        document.getElementById('stealsHeaderPlayer').textContent = '×—×˜\'';
        document.getElementById('blocksHeaderPlayer').textContent = '×—×¡\'';
        document.getElementById('turnoversHeaderPlayer').textContent = '××™×‘\'';
        document.getElementById('foulsHeaderPlayer').textContent = '×¢×‘\'';
        document.getElementById('foulsDrawnHeaderPlayer').textContent = '×¡×—×˜\'';
        document.getElementById('efficiencyHeaderPlayer').textContent = '×™×¢×™×œ×•×ª';
        
        // Update column onclick handlers for averages
        updatePlayerColumnHandlers('averages');
        
        // Get averages data
        const averages = window.ibbaAnalytics.getPlayerAverages();
        allPlayerStats = averages.map(player => ({
          ...player,
          name: getPlayerDisplayName(player)
        }));
      }
      
      // Repopulate filter and re-filter
      populatePlayerTeamFilter();
      filterPlayers();
    }
    
    /**
     * Update player column onclick handlers based on view
     */
    function updatePlayerColumnHandlers(view) {
      // This ensures the onclick handlers reference the correct field names
      // Since we're using consistent field names (ppg, rpg, etc.) across both views,
      // we don't need to change the handlers - they'll work for both views
    }
    
    /**
     * Filter players by team and search term
     */
    function filterPlayers() {
      const teamFilter = document.getElementById('playersTeamFilter').value;
      const searchTerm = document.getElementById('playersSearch').value.toLowerCase().trim();
      
      filteredPlayerStats = allPlayerStats.filter(player => {
        // Team filter
        if (teamFilter && player.teamName !== teamFilter) {
          return false;
        }
        
        // Search filter
        if (searchTerm) {
          const searchableText = `
            ${player.name} 
            ${player.jersey} 
            ${player.teamName}
          `.toLowerCase();
          
          if (!searchableText.includes(searchTerm)) {
            return false;
          }
        }
        
        return true;
      });
      
      // Sort and render
      sortPlayers(currentPlayerSort.field, true);
    }
    
    /**
     * Clear player filters
     */
    function clearPlayerFilters() {
      document.getElementById('playersTeamFilter').value = '';
      document.getElementById('playersSearch').value = '';
      filterPlayers();
    }
    
    /**
     * Sort players by field
     */
    function sortPlayers(field, skipToggle = false) {
      console.log(`ğŸ‘¥ Sorting players by ${field}`);
      
      // Toggle direction if clicking same field
      if (!skipToggle && currentPlayerSort.field === field) {
        currentPlayerSort.direction = currentPlayerSort.direction === 'asc' ? 'desc' : 'asc';
      } else if (!skipToggle) {
        currentPlayerSort.field = field;
        currentPlayerSort.direction = 'desc'; // Default descending for new field
      }
      
      // Sort
      filteredPlayerStats.sort((a, b) => {
        let valA = a[field];
        let valB = b[field];
        
        // Handle string fields
        if (field === 'name' || field === 'teamName') {
          const comparison = String(valA).localeCompare(String(valB), 'he');
          return currentPlayerSort.direction === 'asc' ? comparison : -comparison;
        }
        
        // Handle numeric fields - convert strings to numbers if needed
        valA = parseFloat(valA) || 0;
        valB = parseFloat(valB) || 0;
        
        if (currentPlayerSort.direction === 'asc') {
          return valA - valB;
        } else {
          return valB - valA;
        }
      });
      
      // Update indicators
      updatePlayerSortIndicators();
      
      // Render
      renderPlayers();
    }
    
    /**
     * Update player sort indicators
     */
    function updatePlayerSortIndicators() {
      // Clear all
      document.querySelectorAll('#view-players .sort-indicator').forEach(span => {
        span.textContent = '';
      });
      
      // Set current
      const indicator = document.getElementById(`sort-${currentPlayerSort.field}`);
      if (indicator) {
        indicator.textContent = currentPlayerSort.direction === 'asc' ? 'â–²' : 'â–¼';
      }
    }
    
    /**
     * Render players table
     */
    function renderPlayers() {
      const tbody = document.getElementById('playersTbody');
      const countSpan = document.getElementById('playersCount');
      
      if (!filteredPlayerStats.length) {
        tbody.innerHTML = '<tr><td colspan="16" class="text-center py-8 text-gray-500">×œ× × ××¦××• ×©×—×§× ×™×</td></tr>';
        countSpan.textContent = '0';
        return;
      }
      
      tbody.innerHTML = filteredPlayerStats.map(player => {
        // All fields are now consistently named (ppg, rpg, etc.) regardless of view
        return `
          <tr class="hover:bg-blue-50 transition">
            <td class="col-name font-semibold text-blue-900">${player.name}</td>
            <td class="col-jersey">${player.jersey}</td>
            <td class="col-team">${player.teamName}</td>
            <td class="col-games">${player.gamesPlayed}</td>
            <td class="num">${formatPlayerNumber(player.ppg)}</td>
            <td class="num">${formatPlayerNumber(player.rpg)}</td>
            <td class="num">${formatPlayerNumber(player.apg)}</td>
            <td class="num">${formatPlayerNumber(player.spg)}</td>
            <td class="num">${formatPlayerNumber(player.bpg)}</td>
            <td class="num">${formatPlayerNumber(player.tpg)}</td>
            <td class="num">${formatPlayerNumber(player.fpg)}</td>
            <td class="num">${formatPlayerNumber(player.foulsDrawnPg)}</td>
            <td class="num pct">${formatPercentage(player.fgPct)}</td>
            <td class="num pct">${formatPercentage(player.threePtPct)}</td>
            <td class="num pct">${formatPercentage(player.ftPct)}</td>
            <td class="num">${formatPlayerNumber(player.efficiencyAvg)}</td>
          </tr>
        `;
      }).join('');
      
      countSpan.textContent = filteredPlayerStats.length;
    }
    
    /**
     * Format player number (1 decimal for averages, 0 for totals)
     */
    function formatPlayerNumber(num) {
      if (num == null || isNaN(num)) return '-';
      
      const n = parseFloat(num);
      if (currentPlayerStatsView === 'averages') {
        return n.toFixed(1);
      } else {
        return Math.round(n).toString();
      }
    }
    
    // ========================================
    // INITIALIZATION
    // ========================================
    
    async function init() {
      try {
        updateProgress(0, '×××ª×—×œ ××•×“×•×œ×™×...', '×™×•×¦×¨ ×—×™×‘×•×¨ ×œ-API...');
        
        // Create adapter
        const adapter = new window.IBBAAdapter();
        console.log('âœ… Adapter initialized');
        
        // Load games progressively
        await loadGamesProgressive(adapter);
        
        // Initialize analytics
        console.log('ğŸ“Š Initializing analytics engine...');
        window.ibbaAnalytics = new window.IBBAAnalytics(allGames);
        console.log('âœ… Analytics engine initialized');
        
        // === Initialize player names loader ===
        if (window.IBBAPlayerNames) {
          console.log('ğŸ¯ Initializing player names loader...');
          
          // Initialize Supabase if configured
          let supabase = null;
          const supabaseUrl = window.appConfig?.supabaseUrl || window.CONFIG?.SUPABASE_URL;
          const supabaseKey = window.appConfig?.supabaseKey || window.CONFIG?.SUPABASE_ANON_KEY;
          
          if (supabaseUrl && supabaseKey) {
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            console.log('âœ… Supabase client initialized');
          }
          
          window.playerNamesLoader = new window.IBBAPlayerNames(supabase);
          
          // Check if we have cached names
          if (window.playerNamesLoader.hasCachedNames()) {
            console.log('âœ… Player names loaded from cache (instant!)');
          } else {
            // Try loading from Supabase first (fastest!)
            console.log('ğŸ”„ Loading player names from Supabase...');
            
            window.playerNamesLoader.loadFromSupabase()
              .then(count => {
                if (count > 0) {
                  console.log(`âœ… Loaded ${count} names from Supabase!`);
                  // Refresh player tab if open
                  if (currentTab === 'players') {
                    renderPlayers();
                  }
                } else {
                  // Fallback to API
                  console.log('â„¹ï¸ No names in Supabase, loading from API...');
                  return window.playerNamesLoader.loadAllPlayerNames((progress) => {
                    const statusDiv = document.getElementById('playerNamesStatus');
                    if (statusDiv && progress.stage === 'fetching') {
                      statusDiv.innerHTML = `<span class="animate-pulse">â³ ${progress.message || '×˜×•×¢×Ÿ ×-API...'}</span>`;
                      statusDiv.style.display = 'block';
                    }
                  });
                }
              })
              .then(() => {
                console.log('âœ… Player names ready');
                // Hide status
                const statusDiv = document.getElementById('playerNamesStatus');
                if (statusDiv) statusDiv.style.display = 'none';
                // Refresh if needed
                if (currentTab === 'players') renderPlayers();
              })
              .catch(error => {
                console.warn('âš ï¸ Player names load failed:', error);
              });
            
            // Old API-only fallback (commented out - now using Supabase first)
            /*
            console.log('ğŸ”„ Loading player names from API...');
            
            window.playerNamesLoader.loadAllPlayerNames((progress) => {
              // Update status div if exists
              const statusDiv = document.getElementById('playerNamesStatus');
              if (statusDiv) {
                if (progress.stage === 'fetching') {
                  statusDiv.innerHTML = `<span class="animate-pulse">â³ ${progress.message || '×˜×•×¢×Ÿ ×©×—×§× ×™×...'}</span>`;
                  statusDiv.style.display = 'block';
                } else if (progress.stage === 'processing') {
                  statusDiv.innerHTML = '<span class="animate-pulse">â³ ××¢×‘×“ × ×ª×•× ×™×...</span>';
                  statusDiv.style.display = 'block';
                } else if (progress.stage === 'complete') {
                  statusDiv.style.display = 'none';
                }
              }
              
              // Console progress
              if (progress.stage === 'fetching') {
                console.log(`ğŸ“¥ ${progress.message}`);
              } else if (progress.stage === 'complete') {
                console.log('âœ… Player names loaded successfully');
              }
            })
            .then(() => {
              console.log('âœ… Player names ready:', window.playerNamesLoader.getStats());
              
              const statusDiv = document.getElementById('playerNamesStatus');
              if (statusDiv) {
                statusDiv.innerHTML = 'âœ… ×©××•×ª ×©×—×§× ×™× × ×˜×¢× ×•';
                setTimeout(() => statusDiv.style.display = 'none', 2000);
              }
              
              // If player tab is currently open, refresh it
              const playerTab = document.getElementById('view-players');
              if (playerTab && !playerTab.classList.contains('hidden')) {
                console.log('ğŸ”„ Refreshing player tab with names...');
                renderPlayers();
              }
            })
            .catch(error => {
              console.warn('âš ï¸ Failed to load player names:', error);
              console.log('â¡ï¸ Will continue with "Player #X" fallback');
              
              const statusDiv = document.getElementById('playerNamesStatus');
              if (statusDiv) {
                statusDiv.innerHTML = 'âš ï¸ ×©××•×ª ×©×—×§× ×™× ×œ× ×–××™× ×™×';
                setTimeout(() => statusDiv.style.display = 'none', 3000);
              }
            });
            */
          }
        } else {
          console.warn('âš ï¸ Player names module not loaded');
        }
        // === END player names initialization ===
        
        // Setup UI
        setupEventListeners();
        
        // Hide loading, show games tab (default)
        document.getElementById('loadingProgress').classList.add('hidden');
        document.getElementById('view-games').classList.remove('hidden');
        
        console.log('âœ… Dashboard initialized successfully');
        
      } catch (error) {
        console.error('âŒ Initialization failed:', error);
        showError(`×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×©×‘×•×¨×“: ${error.message}`);
      }
    }
    
    // ========================================
    // PROGRESSIVE LOADING
    // ========================================
    
    async function loadGamesProgressive(adapter) {
      console.log('ğŸ“Š Starting progressive loading...');
      
      const now = new Date().toISOString();
      
      // Phase 1: Load 50 games preview
      console.time('â±ï¸ Load 50 games');
      updateProgress(10, 'ğŸ“¡ ×˜×•×¢×Ÿ ×ª×¦×•×’×” ××§×“×™××”...', '××©×™×›×ª 50 ××©×—×§×™× ×¨××©×•× ×™×...');
      
      const rawGames50 = await adapter.fetchGames(50, now, null);
      const games50 = rawGames50
        .map(g => adapter.convertToInternalFormat(g))
        .filter(g => g.players && g.players.length > 0);
      
      console.timeEnd('â±ï¸ Load 50 games');
      console.log(`âœ… Loaded ${games50.length} games (preview)`);
      
      // Show preview
      window.allGames = games50;
      allGames = window.allGames;
      processGames();
      populateFilters();
      applyFilters();
      
      updateProgress(40, `âœ… × ×˜×¢× ×• ${games50.length} ××©×—×§×™×`, '×˜×•×¢×Ÿ ××©×—×§×™× × ×•×¡×¤×™× ×‘×¨×§×¢...');
      
      // Phase 2: Load remaining games
      console.time('â±ï¸ Load full dataset');
      updateProgress(50, 'ğŸ“¡ ×˜×•×¢×Ÿ ××¢×¨×š ××œ×...', '××©×™×›×ª ×¢×“ 500 ××©×—×§×™×...');
      
      const rawGamesFull = await adapter.fetchGames(500, now, null);
      const gamesFull = rawGamesFull
        .map(g => adapter.convertToInternalFormat(g))
        .filter(g => g.players && g.players.length > 0);
      
      console.timeEnd('â±ï¸ Load full dataset');
      console.log(`âœ… Loaded ${gamesFull.length} games (full dataset)`);
      
      // Update with full dataset
      window.allGames = gamesFull;
      allGames = window.allGames;
      processGames();
      populateFilters();
      applyFilters();
      
      updateProgress(100, `âœ… ×”×•×©×œ×!`, `× ×˜×¢× ×• ${gamesFull.length} ××©×—×§×™× ×‘×”×¦×œ×—×”`);
      
      // Wait a bit before hiding loading UI
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    // ========================================
    // DATA PROCESSING
    // ========================================
    
    function processGames() {
      console.log(`ğŸ”„ Processing ${allGames.length} games...`);
      
      // Add date object for sorting
      allGames.forEach(game => {
        // Create date object for sorting
        game.dateObj = new Date(game.date);
      });
      
      // Initial sort (by gameId desc)
      sortGames(currentSort.field, true);
      
      console.log('âœ… Games processed');
    }
    
    // ========================================
    // FILTERS
    // ========================================
    
    function populateFilters() {
      console.log('ğŸ”§ Populating filters...');
      
      // Populate round filter
      const rounds = [...new Set(allGames.map(g => g.cycle).filter(c => c !== null && c !== undefined))];
      rounds.sort((a, b) => a - b);
      
      const cycleFilter = document.getElementById('cycleFilter');
      cycleFilter.innerHTML = '<option value="">×”×›×œ</option>';
      rounds.forEach(round => {
        const option = document.createElement('option');
        option.value = round;
        option.textContent = `××—×–×•×¨ ${round}`;
        cycleFilter.appendChild(option);
      });
      
      // Populate team filter
      const teams = new Set();
      allGames.forEach(g => {
        if (g.homeTeam) teams.add(g.homeTeam);
        if (g.awayTeam) teams.add(g.awayTeam);
      });
      
      const sortedTeams = [...teams].sort();
      const teamFilter = document.getElementById('teamFilter');
      teamFilter.innerHTML = '<option value="">×”×›×œ</option>';
      sortedTeams.forEach(team => {
        const option = document.createElement('option');
        option.value = team;
        option.textContent = team;
        teamFilter.appendChild(option);
      });
      
      console.log(`âœ… Filters populated: ${rounds.length} rounds, ${sortedTeams.length} teams`);
    }
    
    function applyFilters() {
      const cycleValue = document.getElementById('cycleFilter').value;
      const teamValue = document.getElementById('teamFilter').value;
      const searchValue = document.getElementById('gamesSearch').value.toLowerCase().trim();
      
      console.log('ğŸ” Applying filters:', { cycle: cycleValue, team: teamValue, search: searchValue });
      
      filteredGames = allGames.filter(game => {
        // Round filter
        if (cycleValue && game.cycle != cycleValue) {
          return false;
        }
        
        // Team filter
        if (teamValue && game.homeTeam !== teamValue && game.awayTeam !== teamValue) {
          return false;
        }
        
        // Search filter
        if (searchValue) {
          const searchableText = `${game.gameId} ${game.homeTeam} ${game.awayTeam}`.toLowerCase();
          if (!searchableText.includes(searchValue)) {
            return false;
          }
        }
        
        return true;
      });
      
      console.log(`âœ… Filtered: ${filteredGames.length} / ${allGames.length} games`);
      renderGames();
    }
    
    function clearFilters() {
      document.getElementById('cycleFilter').value = '';
      document.getElementById('teamFilter').value = '';
      document.getElementById('gamesSearch').value = '';
      applyFilters();
    }
    
    // ========================================
    // SORTING
    // ========================================
    
    function sortGames(field, skipToggle = false) {
      console.log(`ğŸ“Š Sorting by ${field}...`);
      
      // Toggle direction if same field (unless skipToggle)
      if (!skipToggle && currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else if (!skipToggle) {
        currentSort.field = field;
        currentSort.direction = 'asc';
      }
      
      // Sort filteredGames if filters are active, otherwise sort allGames
      const gamesToSort = filteredGames.length > 0 || document.getElementById('cycleFilter').value || document.getElementById('teamFilter').value || document.getElementById('gamesSearch').value 
        ? filteredGames 
        : allGames;
      
      gamesToSort.sort((a, b) => {
        let valA, valB;
        
        if (field === 'date') {
          valA = a.dateObj.getTime();
          valB = b.dateObj.getTime();
        } else if (field === 'cycle') {
          valA = a.cycle || 0;
          valB = b.cycle || 0;
        } else {
          valA = a[field];
          valB = b[field];
        }
        
        if (currentSort.direction === 'asc') {
          return valA > valB ? 1 : valA < valB ? -1 : 0;
        } else {
          return valA < valB ? 1 : valA > valB ? -1 : 0;
        }
      });
      
      updateSortIndicators();
      renderGames();
      
      console.log(`âœ… Sorted by ${field} (${currentSort.direction})`);
    }
    
    function updateSortIndicators() {
      // Clear all indicators
      document.querySelectorAll('.sort-indicator').forEach(el => {
        el.textContent = '';
      });
      
      // Set current indicator
      const indicator = document.getElementById(`sort-${currentSort.field}`);
      if (indicator) {
        indicator.textContent = currentSort.direction === 'asc' ? 'â–²' : 'â–¼';
      }
    }
    
    // ========================================
    // RENDERING
    // ========================================
    
    function renderGames() {
      const tbody = document.getElementById('gamesTbody');
      const gamesToRender = filteredGames.length > 0 || document.getElementById('cycleFilter').value || document.getElementById('teamFilter').value || document.getElementById('gamesSearch').value
        ? filteredGames
        : allGames;
      
      if (gamesToRender.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">×œ× × ××¦××• ××©×—×§×™× ×”×ª×•×××™× ×œ×—×™×¤×•×©</td></tr>';
        updateCounts(0);
        return;
      }
      
      tbody.innerHTML = gamesToRender.map(game => {
        const dateStr = game.dateObj.toLocaleDateString('he-IL', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
        
        const cycleStr = game.cycle ? game.cycle : '-';
        
        return `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="col-team">${game.gameId}</td>
            <td class="num">${cycleStr}</td>
            <td class="num">${dateStr}</td>
            <td class="col-team font-semibold">${game.homeTeam} - ${game.awayTeam}</td>
            <td class="col-team text-center font-bold">
              ${game.awayScore}-${game.homeScore}
            </td>
          </tr>
        `;
      }).join('');
      
      updateCounts(gamesToRender.length);
    }
    
    function updateCounts(displayed) {
      document.getElementById('displayedCount').textContent = displayed;
      document.getElementById('totalCount').textContent = allGames.length;
    }
    
    // ========================================
    // UI UPDATES
    // ========================================
    
    function updateProgress(percent, status, details) {
      document.getElementById('loadingBar').style.width = `${percent}%`;
      document.getElementById('loadingStatus').textContent = status;
      document.getElementById('loadingDetails').textContent = details;
    }
    
    function showError(message) {
      const loadingDiv = document.getElementById('loadingProgress');
      loadingDiv.innerHTML = `
        <div class="text-center">
          <div class="text-red-600 text-lg font-semibold mb-2">âŒ ${message}</div>
          <button onclick="location.reload()" class="btn bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">
            ğŸ”„ × ×¡×” ×©×•×‘
          </button>
          <div class="mt-4 bg-amber-50 border border-amber-200 rounded-lg p-4 text-right">
            <p class="text-xs text-amber-800 mb-2"><strong>ğŸ’¡ ×¤×ª×¨×•× ×•×ª ××¤×©×¨×™×™×:</strong></p>
            <div class="text-xs text-amber-700 space-y-1">
              <div>â€¢ <strong>HTTP Server:</strong> ×”×¨×¥ ××ª ×”××ª×¨ ×“×¨×š HTTP server (×œ× file://)</div>
              <div>â€¢ <strong>×¤×§×•×“×”:</strong> <code class="bg-amber-100 px-1 rounded">python -m http.server 8000</code></div>
              <div>â€¢ <strong>×’×©:</strong> http://localhost:8000/ibba_dashboard_v1.html</div>
            </div>
          </div>
        </div>
      `;
    }
    
    // ========================================
    // EVENT LISTENERS
    // ========================================
    
    function setupEventListeners() {
      console.log('ğŸ”— Setting up event listeners...');
      
      // Filter change events
      document.getElementById('cycleFilter').addEventListener('change', applyFilters);
      document.getElementById('teamFilter').addEventListener('change', applyFilters);
      
      // Search
      document.getElementById('searchBtn').addEventListener('click', applyFilters);
      document.getElementById('gamesSearch').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          applyFilters();
        }
      });
      
      // Clear filters
      document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
      
      // Sortable headers (only for games table)
      document.querySelectorAll('#view-games .sortable').forEach(header => {
        header.addEventListener('click', () => {
          const field = header.dataset.sort;
          sortGames(field);
        });
      });
      
      console.log('âœ… Event listeners attached');
    }
    
    // ========================================
    // START
    // ========================================
    
    // Wait for DOM and IBBAAdapter to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        if (window.IBBAAdapter) {
          init();
        } else {
          console.error('âŒ IBBAAdapter not loaded');
          showError('××•×“×•×œ IBBAAdapter ×œ× × ×˜×¢×Ÿ. ×•×“× ×©×”×§×•×‘×¥ js/ibba/ibba_adapter.js ×§×™×™×.');
        }
      });
    } else {
      if (window.IBBAAdapter) {
        init();
      } else {
        console.error('âŒ IBBAAdapter not loaded');
        showError('××•×“×•×œ IBBAAdapter ×œ× × ×˜×¢×Ÿ. ×•×“× ×©×”×§×•×‘×¥ js/ibba/ibba_adapter.js ×§×™×™×.');
      }
    }
    
    console.log('ğŸ“Š IBBA Dashboard v1 script loaded');
    
    // ========================================
    // DEBUG FUNCTION - Identify Missing Players
    // ========================================
    
    async function debugMissingPlayers() {
      console.log('ğŸ” Starting debug - searching for players with missing names...');
      
      // Wait for everything to load
      await new Promise(resolve => setTimeout(resolve, 3000));
      
      if (!window.ibbaAnalytics || !window.playerNamesLoader) {
        console.error('âŒ Required modules not loaded yet');
        return;
      }
      
      const games = window.ibbaAnalytics.games;
      const namesMap = window.playerNamesLoader.namesMap;
      
      console.log(`ğŸ“Š Total games: ${games.length}`);
      console.log(`ğŸ‘¥ Total players in namesMap: ${namesMap.size}`);
      
      // Collect all playerIds from games
      const allPlayerIds = new Set();
      const playerDetails = new Map(); // playerId â†’ {jersey, teamName, teamId, games}
      
      games.forEach(game => {
        game.players.forEach(player => {
          const id = String(player.playerId);
          allPlayerIds.add(id);
          
          if (!playerDetails.has(id)) {
            playerDetails.set(id, {
              jersey: player.jersey,
              teamName: player.teamName,
              teamId: player.teamId,
              games: []
            });
          }
          playerDetails.get(id).games.push({
            date: game.date,
            homeTeam: game.homeTeam,
            awayTeam: game.awayTeam
          });
        });
      });
      
      console.log(`ğŸ® Unique players in games: ${allPlayerIds.size}`);
      
      // Find missing players
      const missingPlayers = [];
      
      allPlayerIds.forEach(playerId => {
        if (!namesMap.has(playerId)) {
          const details = playerDetails.get(playerId);
          missingPlayers.push({
            playerId,
            ...details
          });
        }
      });
      
      console.log(`\nâŒ Found ${missingPlayers.length} players WITHOUT names in SportsPress API:\n`);
      
      missingPlayers.forEach((player, index) => {
        console.log(`${index + 1}. Player ID: ${player.playerId}`);
        console.log(`   Jersey: #${player.jersey}`);
        console.log(`   Team: ${player.teamName} (ID: ${player.teamId})`);
        console.log(`   Games played: ${player.games.length}`);
        console.log(`   Last game: ${player.games[player.games.length - 1].date}`);
        console.log(`   ---`);
      });
      
      // Save list to window for further inspection
      window.missingPlayersDebug = missingPlayers;
      
      console.log('\nğŸ’¡ Access full data: window.missingPlayersDebug');
      console.log('\nâ„¹ï¸ Only players from league 119474 are loaded (by design)');
      
      return missingPlayers;
    }
    
    // ========================================
    // LEAGUE LEADERS FUNCTIONS
    // ========================================
    
    /**
     * Initialize league leaders statistics
     * Filters: 50% minimum games, specific attempts thresholds per stat
     */
    function initLeaderStats() {
      if (!window.ibbaAnalytics) {
        console.error('âŒ Analytics not loaded');
        return;
      }
      
      console.log('ğŸ† Initializing league leaders...');
      
      try {
        // Get all player stats
        const allPlayers = window.ibbaAnalytics.getPlayerAverages();
        console.log(`ğŸ“Š Total players: ${allPlayers.length}`);
        
        // Calculate games per team
        const teamGames = {};
        allGames.forEach(game => {
          teamGames[game.homeTeam] = (teamGames[game.homeTeam] || 0) + 1;
          teamGames[game.awayTeam] = (teamGames[game.awayTeam] || 0) + 1;
        });
        
        console.log(`ğŸ® Teams and their game counts:`, teamGames);
        
        // Filter eligible players (50% of their team's games)
        const eligiblePlayers = allPlayers.filter(p => {
          const teamName = p.teamName;
          const teamTotalGames = teamGames[teamName] || 0;
          const minGamesForTeam = Math.ceil(teamTotalGames * 0.5);
          return p.gamesPlayed >= minGamesForTeam && teamTotalGames > 0;
        });
        
        console.log(`âœ… Eligible players (50% of team games): ${eligiblePlayers.length}`);
        
        // Helper: Get top N players by stat
        const getTopPlayers = (stat, n = 5) => {
          return [...eligiblePlayers]
            .filter(p => parseFloat(p[stat]) > 0)
            .sort((a, b) => parseFloat(b[stat]) - parseFloat(a[stat]))
            .slice(0, n);
        };
        
        // Helper: Get top N players by percentage with minimum attempts per game
        const getTopPlayersByPercentage = (percentageStat, minAttemptsPerGame, n = 5) => {
          return [...eligiblePlayers]
            .filter(p => {
              const percentage = parseFloat(p[percentageStat]) || 0;
              const gamesPlayed = p.gamesPlayed || 1;
              
              // For FG%: check FGA
              // For 3PT%: check 3PA  
              // For FT%: check FTA
              let attemptsPerGame = 0;
              if (percentageStat === 'fgPct') {
                const totalFGA = p._totalFGA || 0;
                attemptsPerGame = totalFGA / gamesPlayed;
              } else if (percentageStat === 'threePtPct') {
                const total3PA = p._total3PA || 0;
                attemptsPerGame = total3PA / gamesPlayed;
              } else if (percentageStat === 'ftPct') {
                const totalFTA = p._totalFTA || 0;
                attemptsPerGame = totalFTA / gamesPlayed;
              }
              
              return attemptsPerGame >= minAttemptsPerGame && percentage > 0;
            })
            .sort((a, b) => parseFloat(b[percentageStat]) - parseFloat(a[percentageStat]))
            .slice(0, n);
        };
        
        // Get top players for each category
        leaderStats = {
          points: getTopPlayers('ppg'),
          rebounds: getTopPlayers('rpg'),
          assists: getTopPlayers('apg'),
          steals: getTopPlayers('spg'),
          blocks: getTopPlayers('bpg'),
          minutes: getTopPlayers('mpg'),
          efficiency: getTopPlayers('efficiencyAvg'),
          // Percentage stats with minimum attempts per game thresholds
          fieldGoal: getTopPlayersByPercentage('fgPct', 4),     // 4 FGA/game
          threePoint: getTopPlayersByPercentage('threePtPct', 2), // 2 3PA/game
          freeThrow: getTopPlayersByPercentage('ftPct', 3)      // 3 FTA/game
        };
        
        console.log('âœ… League leaders calculated:', {
          points: leaderStats.points.length,
          rebounds: leaderStats.rebounds.length,
          assists: leaderStats.assists.length,
          steals: leaderStats.steals.length,
          blocks: leaderStats.blocks.length,
          minutes: leaderStats.minutes.length,
          fieldGoal: leaderStats.fieldGoal.length,
          threePoint: leaderStats.threePoint.length,
          freeThrow: leaderStats.freeThrow.length
        });
        
        // Render the tables
        renderLeaderStats();
        
      } catch (error) {
        console.error('âŒ Error calculating league leaders:', error);
      }
    }
    
    /**
     * Render all league leader tables
     */
    function renderLeaderStats() {
      if (!leaderStats) {
        console.error('âŒ No leader stats to render');
        return;
      }
      
      console.log('ğŸ¨ Rendering league leaders tables...');
      
      // Helper: Get player name from loader
      const getPlayerName = (player) => {
        if (window.playerNamesLoader && window.playerNamesLoader.namesMap) {
          const playerData = window.playerNamesLoader.namesMap.get(String(player.playerId));
          if (playerData && playerData.name) {
            return playerData.name;
          }
        }
        // Fallback to jersey number
        return `×©×—×§×Ÿ #${player.jersey || player.playerId}`;
      };
      
      // Helper: Render single table
      const renderTable = (tableId, players, statField, suffix = '') => {
        const tbody = document.querySelector(`#${tableId} tbody`);
        if (!tbody) {
          console.warn(`âš ï¸ Table ${tableId} not found`);
          return;
        }
        
        if (!players || players.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-400">××™×Ÿ × ×ª×•× ×™×</td></tr>';
          return;
        }
        
        tbody.innerHTML = '';
        
        players.forEach((player, index) => {
          const tr = document.createElement('tr');
          tr.className = 'border-b border-gray-100 hover:bg-blue-50';
          
          const playerName = getPlayerName(player);
          const teamName = player.teamName || '×œ× ×™×“×•×¢';
          const games = player.gamesPlayed || 0;
          const statValue = parseFloat(player[statField] || 0).toFixed(1);
          
          tr.innerHTML = `
            <td class="py-2 px-2 font-semibold text-gray-700">${index + 1}</td>
            <td class="py-2 px-2 text-right font-medium">${playerName}</td>
            <td class="py-2 px-2 text-right text-sm text-gray-600">${teamName}</td>
            <td class="py-2 px-2 text-center text-sm text-gray-500">${games}</td>
            <td class="py-2 px-2 text-center font-bold">${statValue}${suffix}</td>
          `;
          
          tbody.appendChild(tr);
        });
      };
      
      // Render all 10 tables
      renderTable('leadersPoints', leaderStats.points, 'ppg');
      renderTable('leadersRebounds', leaderStats.rebounds, 'rpg');
      renderTable('leadersAssists', leaderStats.assists, 'apg');
      renderTable('leadersSteals', leaderStats.steals, 'spg');
      renderTable('leadersBlocks', leaderStats.blocks, 'bpg');
      renderTable('leadersMinutes', leaderStats.minutes, 'mpg');
      renderTable('leadersEfficiency', leaderStats.efficiency, 'efficiencyAvg');
      renderTable('leadersFG', leaderStats.fieldGoal, 'fgPct', '%');
      renderTable('leaders3PT', leaderStats.threePoint, 'threePtPct', '%');
      renderTable('leadersFT', leaderStats.freeThrow, 'ftPct', '%');
      
      console.log('âœ… League leaders rendered successfully');
    }
    
    // ========================================
    // GAME PREPARATION TAB
    // ========================================
    
    /**
     * Initialize Game Prep tab
     */
    async function initGamePrep() {
      console.log('ğŸ€ Initializing Game Prep tab...');
      
      gamePrepState.initialized = true;
      
      // Populate team selects
      populateTeamSelects();
      
      // Load upcoming games from API (using module from index.html)
      if (typeof window.loadUpcomingGames === 'function') {
        try {
          await window.loadUpcomingGames();
        } catch (error) {
          console.error('âŒ Error loading upcoming games:', error);
        }
      } else {
        console.warn('âš ï¸ loadUpcomingGames function not available');
      }
      
      // Setup event listeners
      setupGamePrepEventListeners();
      
      console.log('âœ… Game Prep initialized');
    }
    
    /**
     * Setup event listeners for Game Prep tab
     */
    function setupGamePrepEventListeners() {
      const homeSelect = document.getElementById('homeTeamSelect');
      const awaySelect = document.getElementById('awayTeamSelect');
      const analyzeBtn = document.getElementById('analyzeGame');
      const refreshBtn = document.getElementById('refreshUpcomingGames');
      const roundSelector = document.getElementById('roundSelector');
      const player1Select = document.getElementById('player1Select');
      const player2Select = document.getElementById('player2Select');
      
      if (homeSelect && awaySelect && analyzeBtn) {
        homeSelect.addEventListener('change', () => {
          updateTeamSelects();
          updateAnalyzeButton();
        });
        
        awaySelect.addEventListener('change', () => {
          updateTeamSelects();
          updateAnalyzeButton();
        });
        
        analyzeBtn.addEventListener('click', () => {
          const homeTeam = homeSelect.value;
          const awayTeam = awaySelect.value;
          if (homeTeam && awayTeam && homeTeam !== awayTeam) {
            analyzeGame(homeTeam, awayTeam);
          }
        });
      }
      
      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          if (typeof window.loadUpcomingGames === 'function') {
            window.loadUpcomingGames();
          }
        });
      }
      
      if (roundSelector) {
        roundSelector.addEventListener('change', (e) => {
          if (typeof window.renderSelectedRound === 'function') {
            window.renderSelectedRound(e.target.value);
          }
        });
      }
      
      if (player1Select) {
        player1Select.addEventListener('change', (e) => {
          gamePrepState.selectedPlayer1 = e.target.value;
          updatePlayerComparison();
        });
      }
      
      if (player2Select) {
        player2Select.addEventListener('change', (e) => {
          gamePrepState.selectedPlayer2 = e.target.value;
          updatePlayerComparison();
        });
      }
    }
    
    /**
     * Populate team selection dropdowns
     */
    function populateTeamSelects() {
      if (!allGames || allGames.length === 0) {
        console.warn('âš ï¸ No games loaded yet');
        return;
      }
      
      // Extract unique teams
      const teamsSet = new Set();
      allGames.forEach(game => {
        if (game.homeTeam) teamsSet.add(game.homeTeam);
        if (game.awayTeam) teamsSet.add(game.awayTeam);
      });
      
      const teams = Array.from(teamsSet).sort((a, b) => a.localeCompare(b, 'he'));
      
      const homeSelect = document.getElementById('homeTeamSelect');
      const awaySelect = document.getElementById('awayTeamSelect');
      
      if (homeSelect) {
        homeSelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×•×¦×ª ×‘×™×ª...</option>';
        teams.forEach(team => {
          const option = document.createElement('option');
          option.value = team;
          option.textContent = team;
          homeSelect.appendChild(option);
        });
      }
      
      if (awaySelect) {
        awaySelect.innerHTML = '<option value="">×‘×—×¨ ×§×‘×•×¦×ª ×—×•×¥...</option>';
        teams.forEach(team => {
          const option = document.createElement('option');
          option.value = team;
          option.textContent = team;
          awaySelect.appendChild(option);
        });
      }
      
      console.log(`âœ… Populated team selects with ${teams.length} teams`);
    }
    
    /**
     * Update team selects to prevent selecting same team twice
     */
    function updateTeamSelects() {
      const homeSelect = document.getElementById('homeTeamSelect');
      const awaySelect = document.getElementById('awayTeamSelect');
      
      if (!homeSelect || !awaySelect) return;
      
      const homeTeam = homeSelect.value;
      const awayTeam = awaySelect.value;
      
      // Disable options in away select that match home team
      Array.from(awaySelect.options).forEach(option => {
        option.disabled = option.value && option.value === homeTeam;
      });
      
      // Disable options in home select that match away team
      Array.from(homeSelect.options).forEach(option => {
        option.disabled = option.value && option.value === awayTeam;
      });
    }
    
    /**
     * Enable/disable analyze button
     */
    function updateAnalyzeButton() {
      const homeSelect = document.getElementById('homeTeamSelect');
      const awaySelect = document.getElementById('awayTeamSelect');
      const analyzeBtn = document.getElementById('analyzeGame');
      
      if (!homeSelect || !awaySelect || !analyzeBtn) return;
      
      const homeTeam = homeSelect.value;
      const awayTeam = awaySelect.value;
      
      analyzeBtn.disabled = !(homeTeam && awayTeam && homeTeam !== awayTeam);
    }
    
    
    /**
     * Main game analysis function
     */
    async function analyzeGame(homeTeamName, awayTeamName) {
      console.log('ğŸ“Š Analyzing game:', homeTeamName, 'vs', awayTeamName);
      
      gamePrepState.homeTeamName = homeTeamName;
      gamePrepState.awayTeamName = awayTeamName;
      
      // Show analysis section
      const analysisSection = document.getElementById('gameAnalysis');
      if (analysisSection) {
        analysisSection.classList.remove('hidden');
      }
      
      // Load all analyses
      loadTeamAverages(homeTeamName, awayTeamName);
      loadLastFiveGames(homeTeamName, awayTeamName);
      loadHeadToHeadHistory(homeTeamName, awayTeamName);
      loadPlayersForComparison(homeTeamName, awayTeamName);
      
      console.log('âœ… Game analysis complete');
    }
    
    /**
     * Calculate home/away record and average margins
     */
    function getHomeAwayRecord(teamName, isHome) {
      const teamGames = allGames.filter(g => 
        isHome ? g.homeTeam === teamName : g.awayTeam === teamName
      );
      
      let wins = 0;
      let losses = 0;
      let winsMargin = [];
      let lossesMargin = [];
      
      teamGames.forEach(game => {
        const teamScore = isHome ? game.homeScore : game.awayScore;
        const oppScore = isHome ? game.awayScore : game.homeScore;
        const margin = teamScore - oppScore;
        
        if (margin > 0) {
          wins++;
          winsMargin.push(margin);
        } else {
          losses++;
          lossesMargin.push(margin);
        }
      });
      
      const avgWinsMargin = winsMargin.length > 0 
        ? (winsMargin.reduce((a, b) => a + b, 0) / winsMargin.length).toFixed(1)
        : '0.0';
      
      const avgLossesMargin = lossesMargin.length > 0 
        ? (lossesMargin.reduce((a, b) => a + b, 0) / lossesMargin.length).toFixed(1)
        : '0.0';
      
      return {
        record: `${wins}-${losses}`,
        wins,
        losses,
        avgWinsMargin: parseFloat(avgWinsMargin),
        avgLossesMargin: parseFloat(avgLossesMargin)
      };
    }
    
    /**
     * Load team averages and rankings
     */
    function loadTeamAverages(homeTeamName, awayTeamName) {
      console.log('ğŸ“ˆ Loading team averages...');
      
      if (!window.ibbaAnalytics) {
        console.error('âŒ Analytics not loaded');
        return;
      }
      
      const allTeamAvgs = window.ibbaAnalytics.getTeamAverages();
      
      const homeTeam = allTeamAvgs.find(t => t.teamName === homeTeamName);
      const awayTeam = allTeamAvgs.find(t => t.teamName === awayTeamName);
      
      if (!homeTeam || !awayTeam) {
        console.error('âŒ Teams not found in averages');
        return;
      }
      
      // Get home/away records
      const homeRecord = getHomeAwayRecord(homeTeamName, true);
      const awayRecord = getHomeAwayRecord(awayTeamName, false);
      
      // Calculate rankings
      const getRanking = (teams, field, value) => {
        const sorted = teams
          .map(t => parseFloat(t[field]) || 0)
          .filter(v => v > 0)
          .sort((a, b) => b - a);
        const rank = sorted.findIndex(v => v <= value) + 1;
        return `${rank}/${sorted.length}`;
      };
      
      const homeStats = {
        name: homeTeamName,
        games: homeTeam.gamesPlayed || 0,
        ppg: parseFloat(homeTeam.ppg) || 0,
        rpg: parseFloat(homeTeam.rpg) || 0,
        apg: parseFloat(homeTeam.apg) || 0,
        spg: parseFloat(homeTeam.spg) || 0,
        bpg: parseFloat(homeTeam.bpg) || 0,
        efficiency: parseFloat(homeTeam.efficiencyAvg) || 0,
        rankPpg: getRanking(allTeamAvgs, 'ppg', parseFloat(homeTeam.ppg)),
        rankRpg: getRanking(allTeamAvgs, 'rpg', parseFloat(homeTeam.rpg)),
        rankApg: getRanking(allTeamAvgs, 'apg', parseFloat(homeTeam.apg)),
        rankSpg: getRanking(allTeamAvgs, 'spg', parseFloat(homeTeam.spg)),
        rankBpg: getRanking(allTeamAvgs, 'bpg', parseFloat(homeTeam.bpg)),
        rankEfficiency: getRanking(allTeamAvgs, 'efficiencyAvg', parseFloat(homeTeam.efficiencyAvg)),
        // Home/Away record
        record: homeRecord.record,
        avgWinsMargin: homeRecord.avgWinsMargin,
        avgLossesMargin: homeRecord.avgLossesMargin,
        isHome: true
      };
      
      const awayStats = {
        name: awayTeamName,
        games: awayTeam.gamesPlayed || 0,
        ppg: parseFloat(awayTeam.ppg) || 0,
        rpg: parseFloat(awayTeam.rpg) || 0,
        apg: parseFloat(awayTeam.apg) || 0,
        spg: parseFloat(awayTeam.spg) || 0,
        bpg: parseFloat(awayTeam.bpg) || 0,
        efficiency: parseFloat(awayTeam.efficiencyAvg) || 0,
        rankPpg: getRanking(allTeamAvgs, 'ppg', parseFloat(awayTeam.ppg)),
        rankRpg: getRanking(allTeamAvgs, 'rpg', parseFloat(awayTeam.rpg)),
        rankApg: getRanking(allTeamAvgs, 'apg', parseFloat(awayTeam.apg)),
        rankSpg: getRanking(allTeamAvgs, 'spg', parseFloat(awayTeam.spg)),
        rankBpg: getRanking(allTeamAvgs, 'bpg', parseFloat(awayTeam.bpg)),
        rankEfficiency: getRanking(allTeamAvgs, 'efficiencyAvg', parseFloat(awayTeam.efficiencyAvg)),
        // Home/Away record
        record: awayRecord.record,
        avgWinsMargin: awayRecord.avgWinsMargin,
        avgLossesMargin: awayRecord.avgLossesMargin,
        isHome: false
      };
      
      renderTeamAverages(homeStats, awayStats);
    }
    
    /**
     * Render team averages comparison
     */
    function renderTeamAverages(homeStats, awayStats) {
      const container = document.getElementById('teamAverages');
      if (!container) return;
      
      const createRow = (label, homeVal, homeRank, awayVal, awayRank) => {
        const homeClass = homeVal > awayVal ? 'bg-green-100 text-green-800 font-bold' : 'bg-red-100 text-red-800';
        const awayClass = awayVal > homeVal ? 'bg-green-100 text-green-800 font-bold' : 'bg-red-100 text-red-800';
        
        return `
          <div class="bg-white border border-gray-200 rounded-lg p-3">
            <div class="text-sm font-medium text-gray-600 mb-2">${label}</div>
            <div class="grid grid-cols-2 gap-3">
              <div class="${homeClass} rounded p-2 text-center">
                <div class="font-bold text-lg">${homeVal.toFixed(1)}</div>
                <div class="text-xs mt-1">×“×™×¨×•×’: ${homeRank}</div>
              </div>
              <div class="${awayClass} rounded p-2 text-center">
                <div class="font-bold text-lg">${awayVal.toFixed(1)}</div>
                <div class="text-xs mt-1">×“×™×¨×•×’: ${awayRank}</div>
              </div>
            </div>
          </div>
        `;
      };
      
      const createRecordRow = (homeStats, awayStats) => {
        const homeLocation = '×‘×‘×™×ª';
        const awayLocation = '×‘×—×•×¥';
        
        // Calculate wins - losses for background color
        const homeRecordParts = homeStats.record.split('-');
        const homeWins = parseInt(homeRecordParts[0]);
        const homeLosses = parseInt(homeRecordParts[1]);
        const homeBalance = homeWins - homeLosses;
        
        const awayRecordParts = awayStats.record.split('-');
        const awayWins = parseInt(awayRecordParts[0]);
        const awayLosses = parseInt(awayRecordParts[1]);
        const awayBalance = awayWins - awayLosses;
        
        // Choose background color based on balance
        const homeClass = homeBalance > 0 ? 'bg-green-100 text-green-800' : homeBalance < 0 ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
        const awayClass = awayBalance > 0 ? 'bg-green-100 text-green-800' : awayBalance < 0 ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
        
        return `
          <div class="bg-white border border-gray-200 rounded-lg p-3">
            <div class="text-sm font-medium text-gray-600 mb-2 text-center">×××–×Ÿ ××©×—×§×™×</div>
            <div class="grid grid-cols-2 gap-3">
              <div class="${homeClass} rounded p-3 text-center">
                <div class="font-bold text-2xl">${homeStats.record}</div>
                <div class="text-xs text-gray-600 mt-1 mb-2">${homeLocation}</div>
                <div class="text-xs text-gray-700 mt-1">
                  <div class="text-green-700">×”×¤×¨×© ×××•×¦×¢ ×‘× ×™×¦×—×•× ×•×ª ${homeLocation}: <span dir="ltr">${homeStats.avgWinsMargin > 0 ? '+' : ''}${homeStats.avgWinsMargin}</span></div>
                  <div class="text-red-700 mt-1">×”×¤×¨×© ×××•×¦×¢ ×‘×”×¤×¡×“×™× ${homeLocation}: <span dir="ltr">${homeStats.avgLossesMargin > 0 ? '+' : ''}${homeStats.avgLossesMargin}</span></div>
                </div>
              </div>
              <div class="${awayClass} rounded p-3 text-center">
                <div class="font-bold text-2xl">${awayStats.record}</div>
                <div class="text-xs text-gray-600 mt-1 mb-2">${awayLocation}</div>
                <div class="text-xs text-gray-700 mt-1">
                  <div class="text-green-700">×”×¤×¨×© ×××•×¦×¢ ×‘× ×™×¦×—×•× ×•×ª ${awayLocation}: <span dir="ltr">${awayStats.avgWinsMargin > 0 ? '+' : ''}${awayStats.avgWinsMargin}</span></div>
                  <div class="text-red-700 mt-1">×”×¤×¨×© ×××•×¦×¢ ×‘×”×¤×¡×“×™× ${awayLocation}: <span dir="ltr">${awayStats.avgLossesMargin > 0 ? '+' : ''}${awayStats.avgLossesMargin}</span></div>
                </div>
              </div>
            </div>
          </div>
        `;
      };
      
      container.innerHTML = `
        <div class="text-center mb-3 grid grid-cols-2 gap-3">
          <div class="font-bold text-blue-800">${homeStats.name}</div>
          <div class="font-bold text-purple-800">${awayStats.name}</div>
        </div>
        ${createRow('× ×§×•×“×•×ª ×œ××©×—×§', homeStats.ppg, homeStats.rankPpg, awayStats.ppg, awayStats.rankPpg)}
        ${createRow('×¨×™×‘××•× ×“×™× ×œ××©×—×§', homeStats.rpg, homeStats.rankRpg, awayStats.rpg, awayStats.rankRpg)}
        ${createRow('××¡×™×¡×˜×™× ×œ××©×—×§', homeStats.apg, homeStats.rankApg, awayStats.apg, awayStats.rankApg)}
        ${createRow('×—×˜×™×¤×•×ª ×œ××©×—×§', homeStats.spg, homeStats.rankSpg, awayStats.spg, awayStats.rankSpg)}
        ${createRow('×—×¡×™××•×ª ×œ××©×—×§', homeStats.bpg, homeStats.rankBpg, awayStats.bpg, awayStats.rankBpg)}
        ${createRow('×™×¢×™×œ×•×ª ×œ××©×—×§', homeStats.efficiency, homeStats.rankEfficiency, awayStats.efficiency, awayStats.rankEfficiency)}
        ${createRecordRow(homeStats, awayStats)}
      `;
      
      console.log('âœ… Team averages rendered');
    }
    
    /**
     * Load last 5 games for both teams
     */
    function loadLastFiveGames(homeTeamName, awayTeamName) {
      console.log('ğŸ“‹ Loading last 5 games...');
      
      if (!allGames || allGames.length === 0) return;
      
      // Get last 5 games for each team
      const homeGames = allGames
        .filter(g => g.homeTeam === homeTeamName || g.awayTeam === homeTeamName)
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);
      
      const awayGames = allGames
        .filter(g => g.homeTeam === awayTeamName || g.awayTeam === awayTeamName)
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);
      
      renderLastFiveGames(homeTeamName, homeGames, awayTeamName, awayGames);
    }
    
    /**
     * Render last 5 games
     */
    function renderLastFiveGames(homeTeamName, homeGames, awayTeamName, awayGames) {
      const container = document.getElementById('lastFiveGames');
      if (!container) return;
      
      const renderGamesList = (teamName, games) => {
        if (!games || games.length === 0) {
          return '<div class="text-center text-gray-500 py-4">××™×Ÿ ××©×—×§×™×</div>';
        }
        
        return games.map(game => {
          const isHome = game.homeTeam === teamName;
          const teamScore = isHome ? game.homeScore : game.awayScore;
          const oppScore = isHome ? game.awayScore : game.homeScore;
          const isWin = teamScore > oppScore;
          const resultText = isWin ? '× ×™×¦×—×•×Ÿ' : '×”×¤×¡×“';
          const resultClass = isWin ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
          const date = new Date(game.date).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
          const locationIcon = isHome ? 'ğŸ ' : 'ğŸšŒ';
          const opponent = isHome ? game.awayTeam : game.homeTeam;
          
          // ×¤×•×¨××˜ ×¤×©×•×˜: ×ª××¨×™×š | ×§×‘×•×¦×” ×©×¢×•×§×‘×™× + × ×™×§×•×“ - ×™×¨×™×‘×” + × ×™×§×•×“ | ××™×™×§×•×Ÿ | ×ª×’×™×ª
          // ×”×§×‘×•×¦×” ×©×¢×•×§×‘×™× ××—×¨×™×” ×ª××™×“ ×¨××©×•× ×”, ×œ× ××©× ×” ×‘×™×ª ××• ×—×•×¥
          
          return `
            <div class="bg-white border border-gray-200 rounded p-4 flex items-center justify-start gap-6" dir="rtl">
              <span class="font-medium text-sm">${date} | ${teamName} ${teamScore} - ${oppScore} ${opponent}</span>
              <span class="text-3xl flex-shrink-0">${locationIcon}</span>
              <span class="${resultClass} px-3 py-1 rounded font-semibold text-sm flex-shrink-0 w-20 text-center">${resultText}</span>
            </div>
          `;
        }).join('');
      };
      
      container.innerHTML = `
        <div>
          <h4 class="font-semibold text-gray-700 mb-3">${homeTeamName}</h4>
          <div class="space-y-3">${renderGamesList(homeTeamName, homeGames)}</div>
        </div>
        <div>
          <h4 class="font-semibold text-gray-700 mb-3">${awayTeamName}</h4>
          <div class="space-y-3">${renderGamesList(awayTeamName, awayGames)}</div>
        </div>
      `;
      
      console.log('âœ… Last 5 games rendered');
    }
    
    /**
     * Load head-to-head history
     */
    function loadHeadToHeadHistory(homeTeamName, awayTeamName) {
      console.log('âš”ï¸ Loading head-to-head history...');
      
      if (!allGames || allGames.length === 0) return;
      
      const h2hGames = allGames.filter(game => 
        (game.homeTeam === homeTeamName && game.awayTeam === awayTeamName) ||
        (game.homeTeam === awayTeamName && game.awayTeam === homeTeamName)
      ).sort((a, b) => new Date(b.date) - new Date(a.date));
      
      renderHeadToHeadHistory(homeTeamName, awayTeamName, h2hGames);
    }
    
    /**
     * Render head-to-head history
     */
    function renderHeadToHeadHistory(homeTeamName, awayTeamName, games) {
      const container = document.getElementById('headToHead');
      if (!container) return;
      
      if (!games || games.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-4">××™×Ÿ ××¤×’×©×™× ×™×©×™×¨×™× ×‘×¢×•× ×” ×–×•</div>';
        return;
      }
      
      // Calculate records
      let homeWins = 0, awayWins = 0;
      games.forEach(game => {
        const homeScore = game.homeTeam === homeTeamName ? game.homeScore : game.awayScore;
        const awayScore = game.homeTeam === homeTeamName ? game.awayScore : game.homeScore;
        if (homeScore > awayScore) homeWins++;
        else if (awayScore > homeScore) awayWins++;
      });
      
      container.innerHTML = `
        <div class="mb-4 text-center">
          <span class="font-bold">${homeTeamName}</span>
          <span class="mx-3 text-2xl font-bold">${homeWins} - ${awayWins}</span>
          <span class="font-bold">${awayTeamName}</span>
        </div>
        <table class="w-full text-sm border-collapse bg-white">
          <thead class="bg-gray-100">
            <tr>
              <th class="text-right py-2 px-3 border-b font-semibold">×ª××¨×™×š</th>
              <th class="text-right py-2 px-3 border-b font-semibold">×§×‘×•×¦×ª ×‘×™×ª</th>
              <th class="text-center py-2 px-3 border-b font-semibold">×ª×•×¦××”</th>
              <th class="text-right py-2 px-3 border-b font-semibold">×§×‘×•×¦×ª ×—×•×¥</th>
              <th class="text-center py-2 px-3 border-b font-semibold">××—×–×•×¨</th>
            </tr>
          </thead>
          <tbody>
            ${games.map(game => {
              const date = new Date(game.date).toLocaleDateString('he-IL');
              const cycle = game.cycle || game.stage || '-';
              const winner = game.homeScore > game.awayScore ? game.homeTeam : game.awayTeam;
              const winnerClass = winner === homeTeamName ? 'bg-green-50' : 'bg-purple-50';
              
              return `
                <tr class="${winnerClass} border-b hover:bg-opacity-70">
                  <td class="py-2 px-3">${date}</td>
                  <td class="py-2 px-3 font-medium">${game.homeTeam}</td>
                  <td class="py-2 px-3 text-center font-bold">${game.homeScore} - ${game.awayScore}</td>
                  <td class="py-2 px-3 font-medium">${game.awayTeam}</td>
                  <td class="py-2 px-3 text-center">${cycle}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
      
      console.log('âœ… Head-to-head history rendered');
    }
    
    /**
     * Load players for comparison
     */
    function loadPlayersForComparison(homeTeamName, awayTeamName) {
      console.log('ğŸ‘¥ Loading players for comparison...');
      
      if (!window.ibbaAnalytics) {
        console.error('âŒ Analytics not loaded');
        return;
      }
      
      const allPlayers = window.ibbaAnalytics.getPlayerAverages();
      
      const homePlayers = allPlayers.filter(p => p.teamName === homeTeamName);
      const awayPlayers = allPlayers.filter(p => p.teamName === awayTeamName);
      
      const player1Select = document.getElementById('player1Select');
      const player2Select = document.getElementById('player2Select');
      
      if (player1Select) {
        player1Select.innerHTML = '<option value="">×‘×—×¨ ×©×—×§×Ÿ ×¨××©×•×Ÿ...</option>';
        player1Select.disabled = false;
        
        homePlayers.forEach(player => {
          const option = document.createElement('option');
          option.value = player.playerId;
          option.dataset.team = homeTeamName;
          
          // Get player name
          const playerName = window.playerNamesLoader && window.playerNamesLoader.namesMap
            ? (window.playerNamesLoader.namesMap.get(String(player.playerId))?.name || `×©×—×§×Ÿ #${player.jersey || player.playerId}`)
            : `×©×—×§×Ÿ #${player.jersey || player.playerId}`;
          
          option.textContent = `${playerName} (${homeTeamName})`;
          player1Select.appendChild(option);
        });
      }
      
      if (player2Select) {
        player2Select.innerHTML = '<option value="">×‘×—×¨ ×©×—×§×Ÿ ×©× ×™...</option>';
        player2Select.disabled = false;
        
        awayPlayers.forEach(player => {
          const option = document.createElement('option');
          option.value = player.playerId;
          option.dataset.team = awayTeamName;
          
          // Get player name
          const playerName = window.playerNamesLoader && window.playerNamesLoader.namesMap
            ? (window.playerNamesLoader.namesMap.get(String(player.playerId))?.name || `×©×—×§×Ÿ #${player.jersey || player.playerId}`)
            : `×©×—×§×Ÿ #${player.jersey || player.playerId}`;
          
          option.textContent = `${playerName} (${awayTeamName})`;
          player2Select.appendChild(option);
        });
      }
      
      console.log(`âœ… Loaded ${homePlayers.length} players from ${homeTeamName}, ${awayPlayers.length} from ${awayTeamName}`);
    }
    
    /**
     * Update player comparison when players are selected
     */
    function updatePlayerComparison() {
      const player1Id = gamePrepState.selectedPlayer1;
      const player2Id = gamePrepState.selectedPlayer2;
      
      if (!player1Id || !player2Id) {
        document.getElementById('playerComparison')?.classList.add('hidden');
        return;
      }
      
      console.log('ğŸ”„ Updating player comparison:', player1Id, 'vs', player2Id);
      
      if (!window.ibbaAnalytics) return;
      
      const allPlayers = window.ibbaAnalytics.getPlayerAverages();
      const player1 = allPlayers.find(p => String(p.playerId) === String(player1Id));
      const player2 = allPlayers.find(p => String(p.playerId) === String(player2Id));
      
      if (!player1 || !player2) {
        console.error('âŒ Players not found');
        return;
      }
      
      renderPlayerComparison(player1, player2);
    }
    
    /**
     * Render player comparison table
     */
    function renderPlayerComparison(player1, player2) {
      const comparisonDiv = document.getElementById('playerComparison');
      if (!comparisonDiv) return;
      
      const player1NameHeader = document.getElementById('player1Name');
      const player2NameHeader = document.getElementById('player2Name');
      const tbody = document.getElementById('comparisonTableBody');
      
      if (!tbody) return;
      
      // Get player names
      const getName = (player) => {
        if (window.playerNamesLoader && window.playerNamesLoader.namesMap) {
          return window.playerNamesLoader.namesMap.get(String(player.playerId))?.name || `×©×—×§×Ÿ #${player.jersey || player.playerId}`;
        }
        return `×©×—×§×Ÿ #${player.jersey || player.playerId}`;
      };
      
      const p1Name = getName(player1);
      const p2Name = getName(player2);
      
      // Create comparison rows
      // Create category header row
      const createCategoryHeader = (categoryName, player1Name = null, player2Name = null) => {
        if (player1Name && player2Name) {
          // First category header with player names
          return `
            <tr class="bg-blue-50">
              <td class="px-4 py-3 text-sm font-bold text-blue-800 text-right">${categoryName}</td>
              <td class="px-4 py-3 text-sm font-bold text-blue-800 text-center">${player1Name}</td>
              <td class="px-4 py-3 text-sm font-bold text-blue-800 text-center">${player2Name}</td>
            </tr>
          `;
        } else {
          // Other category headers without player names
          return `
            <tr class="bg-blue-50">
              <td colspan="3" class="px-4 py-3 text-sm font-bold text-blue-800 text-right">${categoryName}</td>
            </tr>
          `;
        }
      };
      
      const createRow = (label, p1Val, p2Val, suffix = '', useLtr = false) => {
        const p1Num = parseFloat(p1Val) || 0;
        const p2Num = parseFloat(p2Val) || 0;
        
        let p1Class, p2Class;
        
        // Special color logic for Plus/Minus: color by absolute value, not by comparison
        if (label === '×¤×œ×•×¡/××™× ×•×¡ ×œ××©×—×§') {
          const getPlusMinusColorClass = (val) => {
            if (val >= 5) return 'bg-green-100 text-green-800 font-bold'; // +5 and above â†’ dark green
            if (val >= 1) return 'bg-green-50 text-green-700'; // +1 to +5 â†’ light green
            if (val >= -1) return 'bg-yellow-50 text-yellow-800'; // -1 to +1 â†’ neutral yellow
            if (val >= -5) return 'bg-red-50 text-red-700'; // -5 to -1 â†’ light red
            return 'bg-red-100 text-red-800 font-bold'; // -5 and below â†’ dark red
          };
          p1Class = getPlusMinusColorClass(p1Num);
          p2Class = getPlusMinusColorClass(p2Num);
        } else {
          // Normal comparison logic for other stats
          p1Class = p1Num > p2Num ? 'bg-green-100 text-green-800 font-bold' : 
                   p1Num < p2Num ? 'bg-red-100 text-red-800' : 
                   'bg-gray-100 text-gray-800';
          p2Class = p2Num > p1Num ? 'bg-green-100 text-green-800 font-bold' : 
                   p2Num < p1Num ? 'bg-red-100 text-red-800' : 
                   'bg-gray-100 text-gray-800';
        }
        
        // For numeric values (especially negative ones), use LTR direction
        const dirAttr = useLtr ? ' dir="ltr"' : '';
        
        // For Plus/Minus, add explicit + sign for positive values
        const formatValue = (val) => {
          if (label === '×¤×œ×•×¡/××™× ×•×¡ ×œ××©×—×§' && val > 0) {
            return `+${val.toFixed(1)}`;
          }
          return `${val.toFixed(1)}${suffix}`;
        };
        
        return `
          <tr>
            <td class="px-4 py-3 text-sm font-medium text-gray-900 text-right">${label}</td>
            <td class="px-4 py-3 text-sm text-center ${p1Class}"${dirAttr}>${formatValue(p1Num)}</td>
            <td class="px-4 py-3 text-sm text-center ${p2Class}"${dirAttr}>${formatValue(p2Num)}</td>
          </tr>
        `;
      };
      
      tbody.innerHTML = `
        ${createCategoryHeader('×¡×˜×˜×™×¡×˜×™×§×•×ª ××©×—×§', p1Name, p2Name)}
        ${createRow('× ×§×•×“×•×ª ×œ××©×—×§', player1.ppg, player2.ppg)}
        ${createRow('×¨×™×‘××•× ×“×™× ×œ××©×—×§', player1.rpg, player2.rpg)}
        ${createRow('××¡×™×¡×˜×™× ×œ××©×—×§', player1.apg, player2.apg)}
        ${createRow('×—×˜×™×¤×•×ª ×œ××©×—×§', player1.spg, player2.spg)}
        ${createRow('×—×¡×™××•×ª ×œ××©×—×§', player1.bpg, player2.bpg)}
        ${createRow('×™×¢×™×œ×•×ª (××“×“) ×œ××©×—×§', player1.efficiencyAvg, player2.efficiencyAvg)}
        ${createRow('×“×§×•×ª ×œ××©×—×§', player1.mpg, player2.mpg)}
        ${createRow('×¤×œ×•×¡/××™× ×•×¡ ×œ××©×—×§', player1.plusMinusPg, player2.plusMinusPg, '', true)}
        <tr><td colspan="3" class="py-2"></td></tr>
        ${createCategoryHeader('×¡×˜×˜×™×¡×˜×™×§×•×ª ×¦×™×•×Ÿ')}
        ${createRow('××—×•×–×™ ×©×“×”', player1.fgPct, player2.fgPct, '%')}
        ${createRow('××—×•×–×™ 3 × ×§×•×“×•×ª', player1.threePtPct, player2.threePtPct, '%')}
        ${createRow('××—×•×–×™ ×¢×•× ×©×™×Ÿ', player1.ftPct, player2.ftPct, '%')}
      `;
      
      comparisonDiv.classList.remove('hidden');
      console.log('âœ… Player comparison rendered');
    }
    
    // Run debug function automatically
    setTimeout(() => {
      debugMissingPlayers();
      
      // Show refresh button after initial load
      const refreshBtn = document.getElementById('refreshPlayerNamesBtn');
      if (refreshBtn && window.playerNamesLoader) {
        refreshBtn.style.display = 'inline-block';
      }
    }, 3500);
    
    /**
     * Force refresh player names from Supabase
     * Clears cache and reloads from server
     */
    async function forceRefreshPlayerNames() {
      if (!window.playerNamesLoader) {
        console.error('âŒ Player names loader not initialized');
        return;
      }
      
      console.log('ğŸ”„ Force refreshing player names...');
      
      // Show loading
      const statusDiv = document.getElementById('playerNamesStatus');
      if (statusDiv) {
        statusDiv.innerHTML = '<span class="animate-pulse">ğŸ”„ ××¨×¢× ×Ÿ ×©××•×ª ×©×—×§× ×™×...</span>';
        statusDiv.style.display = 'block';
      }
      
      // Clear cache
      window.playerNamesLoader.clearCache();
      
      // Reload from Supabase
      try {
        const count = await window.playerNamesLoader.loadFromSupabase();
        
        if (count > 0) {
          console.log(`âœ… Refreshed ${count} player names from Supabase`);
          
          // Refresh player tab if open
          if (currentTab === 'players') {
            // Re-initialize to get fresh names
            initPlayerStats();
          }
          
          if (statusDiv) {
            statusDiv.innerHTML = `âœ… ×¨×•×¢× ×Ÿ! × ×˜×¢× ×• ${count} ×©×—×§× ×™×`;
            setTimeout(() => statusDiv.style.display = 'none', 3000);
          }
        } else {
          throw new Error('No data loaded from Supabase');
        }
        
      } catch (error) {
        console.error('âŒ Refresh failed:', error);
        if (statusDiv) {
          statusDiv.innerHTML = 'âŒ ×¨×¢× ×•×Ÿ × ×›×©×œ';
          setTimeout(() => statusDiv.style.display = 'none', 3000);
        }
      }
    }
    
  </script>
</body>
</html>

