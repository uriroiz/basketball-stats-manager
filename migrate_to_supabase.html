<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×”×¢×‘×¨×ª × ×ª×•× ×™× ×œ-Supabase - Basketball Stats Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .log-entry {
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
    }
    .log-success { color: #10b981; }
    .log-error { color: #ef4444; }
    .log-warning { color: #f59e0b; }
    .log-info { color: #3b82f6; }
  </style>
</head>
<body class="bg-gray-100">
  <div class="min-h-screen py-8 px-4">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg shadow-lg p-6 mb-6">
        <h1 class="text-3xl font-bold text-white mb-2">ğŸš€ ×›×œ×™ ×”×¢×‘×¨×ª × ×ª×•× ×™× ×œ-Supabase</h1>
        <p class="text-blue-100">×”×¢×‘×¨ ××ª ×›×œ ×”× ×ª×•× ×™× ×”××§×•××™×™× ×-IndexedDB ××œ Supabase ×‘×¢× ×Ÿ</p>
      </div>

      <!-- Configuration Card -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">âš™ï¸ ×”×’×“×¨×•×ª Supabase</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Supabase URL</label>
            <input 
              type="text" 
              id="supabaseUrl" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="https://xxxxx.supabase.co"
              dir="ltr"
            />
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Supabase Anon Key</label>
            <input 
              type="password" 
              id="supabaseKey" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
              dir="ltr"
            />
            <p class="mt-1 text-xs text-gray-500">××¦× ××ª ×”×¢×¨×›×™× ×‘-Supabase Dashboard â†’ Settings â†’ API</p>
          </div>

          <button 
            id="testConnectionBtn"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors"
          >
            ğŸ”Œ ×‘×“×•×§ ×—×™×‘×•×¨
          </button>
        </div>
      </div>

      <!-- Migration Status -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4">ğŸ“Š ×¡×˜×˜×•×¡ ×”×¢×‘×¨×”</h2>
        
        <div id="migrationStatus" class="space-y-2 mb-4">
          <!-- Status will be populated here -->
        </div>

        <div class="flex gap-3">
          <button 
            id="startMigrationBtn"
            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            â–¶ï¸ ×”×ª×—×œ ×”×¢×‘×¨×”
          </button>
          
          <button 
            id="clearSupabaseBtn"
            class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            ğŸ—‘ï¸ × ×§×” Supabase
          </button>
        </div>
      </div>

      <!-- Log Console -->
      <div class="bg-gray-900 rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold text-white mb-4">ğŸ“ ×œ×•×’</h2>
        <div id="logConsole" class="bg-black rounded p-4 h-96 overflow-y-auto font-mono text-sm text-green-400">
          <div>×××ª×™×Ÿ ×œ×—×™×‘×•×¨...</div>
        </div>
      </div>

      <!-- Instructions -->
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mt-6">
        <h3 class="text-lg font-bold text-yellow-900 mb-2">âš ï¸ ×”×•×¨××•×ª ×—×©×•×‘×•×ª</h3>
        <ul class="list-disc list-inside space-y-2 text-yellow-800 text-sm">
          <li>×•×“× ×©×™×© ×œ×š × ×ª×•× ×™× ×‘-IndexedDB ×”××§×•××™ (××•×ª×• ×“×¤×“×¤×Ÿ ×©×‘×• ×”×©×ª××©×ª ×‘××¤×œ×™×§×¦×™×”)</li>
          <li>×¤×ª×— ×§×•×‘×¥ ×–×” ×‘××•×ª×• ×“×¤×“×¤×Ÿ ×‘×• ×¢×‘×“×ª ×¢×“ ×›×”</li>
          <li>×•×“× ×©×™×¦×¨×ª ××ª ×”×˜×‘×œ××•×ª ×‘-Supabase (×”×¨×¥ ××ª supabase_schema.sql)</li>
          <li>×”×¢×‘×¨×” ×¢×œ×•×œ×” ×œ×§×—×ª ××¡×¤×¨ ×“×§×•×ª ×ª×œ×•×™ ×‘×›××•×ª ×”× ×ª×•× ×™×</li>
          <li>×œ××—×¨ ×”×¢×‘×¨×” ××•×¦×œ×—×ª, ×”××¤×œ×™×§×¦×™×” ×”×¨××©×™×ª ×ª×¢×‘×•×¨ ××•×˜×•××˜×™×ª ×œ×¢×‘×•×“ ×¢× Supabase</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    let supabaseClient = null;
    let localDB = null;

    const statusEl = document.getElementById('migrationStatus');
    const logEl = document.getElementById('logConsole');
    const startBtn = document.getElementById('startMigrationBtn');
    const clearBtn = document.getElementById('clearSupabaseBtn');
    const testBtn = document.getElementById('testConnectionBtn');
    const urlInput = document.getElementById('supabaseUrl');
    const keyInput = document.getElementById('supabaseKey');

    // Logging
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('he-IL');
      const colors = {
        success: 'text-green-400',
        error: 'text-red-400',
        warning: 'text-yellow-400',
        info: 'text-blue-400'
      };
      const icons = {
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
      };
      
      const entry = document.createElement('div');
      entry.className = colors[type] || colors.info;
      entry.textContent = `[${timestamp}] ${icons[type]} ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      
      console.log(`[${type.toUpperCase()}]`, message);
    }

    function updateStatus(table, count, status) {
      let statusRow = document.getElementById(`status-${table}`);
      if (!statusRow) {
        statusRow = document.createElement('div');
        statusRow.id = `status-${table}`;
        statusRow.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
        statusEl.appendChild(statusRow);
      }
      
      const statusColors = {
        pending: 'text-gray-500',
        progress: 'text-blue-600',
        success: 'text-green-600',
        error: 'text-red-600'
      };
      
      statusRow.innerHTML = `
        <span class="font-medium">${table}</span>
        <span class="${statusColors[status]}">${count} ×¤×¨×™×˜×™× - ${status === 'success' ? '×”×•×©×œ×' : status === 'progress' ? '××¢×‘×™×¨...' : status === 'error' ? '×©×’×™××”' : '×××ª×™×Ÿ'}</span>
      `;
    }

    // Test Supabase connection
    async function testConnection() {
      const url = urlInput.value.trim();
      const key = keyInput.value.trim();

      if (!url || !key) {
        alert('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
        return;
      }

      log('×‘×•×“×§ ×—×™×‘×•×¨ ×œ-Supabase...', 'info');
      testBtn.disabled = true;
      testBtn.textContent = '×‘×•×“×§...';

      try {
        supabaseClient = supabase.createClient(url, key);
        
        // Test query
        const { data, error } = await supabaseClient
          .from('games')
          .select('count', { count: 'exact', head: true });

        if (error) {
          log(`×©×’×™××” ×‘×—×™×‘×•×¨: ${error.message}`, 'error');
          alert('×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ-Supabase. ×•×“× ×©×”-URL ×•×”-Key × ×›×•× ×™×');
          return;
        }

        log('×—×™×‘×•×¨ ×œ-Supabase ×”×¦×œ×™×—!', 'success');
        startBtn.disabled = false;
        clearBtn.disabled = false;
        testBtn.textContent = 'âœ“ ××—×•×‘×¨';
        testBtn.classList.add('bg-green-600');
        
      } catch (error) {
        log(`×©×’×™××”: ${error.message}`, 'error');
        alert('×©×’×™××” ×‘×—×™×‘×•×¨: ' + error.message);
      } finally {
        testBtn.disabled = false;
        if (!supabaseClient) {
          testBtn.textContent = 'ğŸ”Œ ×‘×“×•×§ ×—×™×‘×•×¨';
        }
      }
    }

    // Open local IndexedDB
    async function openLocalDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('BasketballStatsDB', 10);

        request.onsuccess = (e) => {
          localDB = e.target.result;
          log('IndexedDB ××§×•××™ × ×¤×ª×— ×‘×”×¦×œ×—×”', 'success');
          resolve(localDB);
        };

        request.onerror = () => {
          log('×©×’×™××” ×‘×¤×ª×™×—×ª IndexedDB ×”××§×•××™', 'error');
          reject(new Error('×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— ××ª ××¡×“ ×”× ×ª×•× ×™× ×”××§×•××™'));
        };
      });
    }

    // Get all data from IndexedDB store
    async function getAllFromStore(storeName) {
      return new Promise((resolve) => {
        try {
          const tx = localDB.transaction([storeName], 'readonly');
          const store = tx.objectStore(storeName);
          const request = store.getAll();

          request.onsuccess = () => {
            resolve(request.result || []);
          };

          request.onerror = () => {
            log(`×©×’×™××” ×‘×§×¨×™××ª ${storeName}`, 'error');
            resolve([]);
          };
        } catch (error) {
          log(`×©×’×™××” ×‘×’×™×©×” ×œ-${storeName}: ${error.message}`, 'error');
          resolve([]);
        }
      });
    }

    // Migrate single table
    async function migrateTable(tableName) {
      updateStatus(tableName, 0, 'progress');
      log(`××ª×—×™×œ ×”×¢×‘×¨×ª ${tableName}...`, 'info');

      try {
        const data = await getAllFromStore(tableName);
        log(`× ××¦××• ${data.length} ×¤×¨×™×˜×™× ×‘-${tableName}`, 'info');

        if (data.length === 0) {
          updateStatus(tableName, 0, 'success');
          return { success: true, count: 0 };
        }

        // Upload in batches
        const batchSize = 100;
        let successCount = 0;

        for (let i = 0; i < data.length; i += batchSize) {
          const batch = data.slice(i, i + batchSize);
          
          const { error } = await supabaseClient
            .from(tableName)
            .upsert(batch);

          if (error) {
            log(`×©×’×™××” ×‘×”×¢×œ××ª batch ×-${tableName}: ${error.message}`, 'error');
            throw error;
          }

          successCount += batch.length;
          log(`×”×•×¢×œ×• ${successCount}/${data.length} ×¤×¨×™×˜×™× ×-${tableName}`, 'info');
        }

        updateStatus(tableName, successCount, 'success');
        log(`âœ… ${tableName} ×”×•×¢×‘×¨ ×‘×”×¦×œ×—×” (${successCount} ×¤×¨×™×˜×™×)`, 'success');
        return { success: true, count: successCount };

      } catch (error) {
        updateStatus(tableName, 0, 'error');
        log(`âŒ ×©×’×™××” ×‘×”×¢×‘×¨×ª ${tableName}: ${error.message}`, 'error');
        return { success: false, count: 0, error: error.message };
      }
    }

    // Start migration
    async function startMigration() {
      if (!supabaseClient) {
        alert('× × ×œ×‘×“×•×§ ×—×™×‘×•×¨ ×ª×—×™×œ×”');
        return;
      }

      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×¢×‘×™×¨ ××ª ×›×œ ×”× ×ª×•× ×™× ×œ-Supabase? ×¤×¢×•×œ×” ×–×• ×¢×œ×•×œ×” ×œ×§×—×ª ××¡×¤×¨ ×“×§×•×ª.')) {
        return;
      }

      startBtn.disabled = true;
      clearBtn.disabled = true;
      testBtn.disabled = true;

      log('=== ××ª×—×™×œ ×ª×”×œ×™×š ×”×¢×‘×¨×” ===', 'info');

      try {
        // Open local DB
        await openLocalDB();

        // Define tables to migrate (order matters for relationships)
        const tables = [
          'teams',
          'player_mappings',
          'games',
          'players',
          'player_aliases',
          'appearances',
          'player_stats',
          'transfer_events',
          'team_aliases'
        ];

        let totalSuccess = 0;
        let totalErrors = 0;

        for (const table of tables) {
          const result = await migrateTable(table);
          if (result.success) {
            totalSuccess += result.count;
          } else {
            totalErrors++;
          }
        }

        log('=== ×”×¢×‘×¨×” ×”×•×©×œ××” ===', 'success');
        log(`âœ… ×¡×”"×› ×¤×¨×™×˜×™× ×©×”×•×¢×‘×¨×•: ${totalSuccess}`, 'success');
        
        if (totalErrors > 0) {
          log(`âš ï¸ ${totalErrors} ×˜×‘×œ××•×ª ×¢× ×©×’×™××•×ª`, 'warning');
        }

        alert(`×”×¢×‘×¨×” ×”×•×©×œ××”!\n×”×•×¢×‘×¨×• ${totalSuccess} ×¤×¨×™×˜×™×\n\n×›×¢×ª ×ª×•×›×œ ×œ×”×©×ª××© ×‘××¤×œ×™×§×¦×™×” ×”×¨××©×™×ª ×¢× Supabase.`);

      } catch (error) {
        log(`×©×’×™××” ×›×œ×œ×™×ª: ${error.message}`, 'error');
        alert('×©×’×™××” ×‘×ª×”×œ×™×š ×”×”×¢×‘×¨×”: ' + error.message);
      } finally {
        startBtn.disabled = false;
        clearBtn.disabled = false;
        testBtn.disabled = false;
      }
    }

    // Clear Supabase (for testing)
    async function clearSupabase() {
      if (!supabaseClient) {
        alert('× × ×œ×‘×“×•×§ ×—×™×‘×•×¨ ×ª×—×™×œ×”');
        return;
      }

      if (!confirm('âš ï¸ ×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×-Supabase!\n\n×”×× ××ª×” ×‘×˜×•×—?')) {
        return;
      }

      if (!confirm('××™×©×•×¨ ×©× ×™: ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”. ×”×× ×œ×”××©×™×š?')) {
        return;
      }

      clearBtn.disabled = true;
      log('×× ×§×” × ×ª×•× ×™× ×-Supabase...', 'warning');

      try {
        const tables = ['games', 'players', 'teams', 'player_mappings', 'player_aliases', 'appearances', 'player_stats', 'transfer_events', 'team_aliases'];

        for (const table of tables) {
          const { error } = await supabaseClient
            .from(table)
            .delete()
            .neq('id', 0); // Delete all

          if (error && !error.message.includes('No rows')) {
            log(`×©×’×™××” ×‘× ×™×§×•×™ ${table}: ${error.message}`, 'error');
          } else {
            log(`${table} × ×•×§×”`, 'success');
          }
        }

        log('× ×™×§×•×™ ×”×•×©×œ×', 'success');
        alert('×›×œ ×”× ×ª×•× ×™× × ××—×§×• ×-Supabase');

      } catch (error) {
        log(`×©×’×™××” ×‘× ×™×§×•×™: ${error.message}`, 'error');
        alert('×©×’×™××” ×‘× ×™×§×•×™: ' + error.message);
      } finally {
        clearBtn.disabled = false;
      }
    }

    // Event listeners
    testBtn.addEventListener('click', testConnection);
    startBtn.addEventListener('click', startMigration);
    clearBtn.addEventListener('click', clearSupabase);

    // Initial log
    log('×›×œ×™ ×”×¢×‘×¨×” × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”', 'success');
    log('×”×›× ×¡ ××ª ×¤×¨×˜×™ ×”-Supabase ×•×œ×—×¥ "×‘×“×•×§ ×—×™×‘×•×¨"', 'info');
  </script>
</body>
</html>

